@model MDUA.Web.UI.Models.PagedOrderViewModel
@{
    ViewData["Title"] = "All Sales Orders";
    Layout = "_AdminLayout";

    // Get Current States
    string currentStatus = (string)ViewData["CurrentStatus"] ?? "all";
    string currentPay = (string)ViewData["CurrentPayStatus"] ?? "all";
    string currentType = (string)ViewData["CurrentOrderType"] ?? "all";
    string currentDate = (string)ViewData["CurrentDateRange"] ?? "all";
    var currentMin = ViewData["CurrentMinAmount"];
    var currentMax = ViewData["CurrentMaxAmount"];
    string currentSearch = (string)ViewData["CurrentSearch"] ?? "";

    // Check if any filter is active
    bool isFiltered = currentStatus != "all" || currentPay != "all" ||
                      currentType != "all" || currentDate != "all" ||
                      currentMin != null || currentMax != null ||
                      !string.IsNullOrEmpty(currentSearch);

    string collapseClass = isFiltered ? "collapse show" : "collapse";
    string btnClass = isFiltered ? "btn-primary shadow-sm" : "btn-white border shadow-sm";
    string customDateClass = currentDate == "custom" ? "d-flex" : "d-none";
}

@section Styles {
    <link rel="stylesheet" href="~/css/orders.css" asp-append-version="true" />
    <style>
        @@keyframes highlight-pulse {
            0% {
                background-color: rgba(13, 110, 253, 0.0);
            }

            20% {
                background-color: rgba(13, 110, 253, 0.2);
            }

            100% {
                background-color: rgba(13, 110, 253, 0.0);
            }
        }

        .text-maroon {
            color: #c0392b !important;
        }

        .row-highlight {
            animation: highlight-pulse 2s ease-out;
            border-left: 4px solid #0d6efd !important;
            transition: border-left-color 0.3s ease;
        }

        .filter-group {
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .page-link {
            color: #333;
        }

        .page-item.active .page-link {
            background-color: #8b0000;
            border-color: #8b0000;
            color: #fff;
        }

        .page-link:hover {
            color: #8b0000;
            background-color: #f8f9fa;
        }

        .header-search-input {
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            border-left: none;
        }

        .header-search-icon {
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
            border-right: none;
            background-color: white;
        }
    </style>
}

@Html.AntiForgeryToken()

<div class="orders-wrapper">
    <div class="orders-header mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
                <h2 class="fw-bold mb-0">Order List</h2>
                <div class="text-muted small">
                    <span class="text-primary fw-bold">@Model.TotalRows</span> Total Orders
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div class="input-group input-group-sm shadow-sm" style="width: 220px;">
                    <span class="input-group-text bg-white border-end-0 text-muted ps-3">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="headerSearchInput" class="form-control border-start-0" placeholder="Search ID..." value="@currentSearch" autocomplete="off">
                </div>

                <button class="btn btn-sm @btnClass px-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                    <i class="fas fa-filter me-2"></i> Filters
                    @if (isFiltered)
                    {
                        <span class="badge bg-white text-primary ms-1 rounded-pill">On</span>
                    }
                </button>
                <button class="btn btn-sm btn-white border shadow-sm px-3" type="button" data-bs-toggle="modal" data-bs-target="#exportModal">
                    <i class="fas fa-download me-2 text-secondary"></i> Export
                </button>
            </div>
        </div>

        <div class="@collapseClass mt-3" id="filterPanel">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body p-3">
                    <form method="get" action="/order/all" class="d-flex flex-wrap align-items-center justify-content-end gap-3" id="filterForm">
                        <input type="hidden" name="pageSize" value="@Model.PageSize" />
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="search" id="formSearchInput" value="@currentSearch" />

                        <div class="d-flex align-items-center">
                            <label class="small fw-bold text-muted me-2">Type:</label>
                            <select name="orderType" class="form-select form-select-sm border-secondary-subtle bg-white" style="width: 90px;" onchange="this.form.submit()">
                                <option value="all" selected="@(currentType == "all")">All</option>
                                <option value="Online" selected="@(currentType == "Online")">Online</option>
                                <option value="Direct" selected="@(currentType == "Direct")">Direct</option>
                            </select>
                        </div>

                        <div class="vr text-secondary opacity-25"></div>

                        <div class="d-flex align-items-center">
                            <label class="small fw-bold text-muted me-2">Status:</label>
                            <select name="status" class="form-select form-select-sm border-secondary-subtle bg-white" style="width: 130px;" onchange="this.form.submit()">
                                <option value="all" selected="@(currentStatus == "all")">All</option>
                                <option value="Draft" selected="@(currentStatus == "Draft")">Pending</option>
                                <option value="Confirmed" selected="@(currentStatus == "Confirmed")">Confirmed</option>
                                <option value="Shipped" selected="@(currentStatus == "Shipped")">Shipped</option>
                                <option value="Delivered" selected="@(currentStatus == "Delivered")">Delivered</option>
                                <option value="Returned" selected="@(currentStatus == "Returned")">Returned</option>
                                <option value="Cancelled" selected="@(currentStatus == "Cancelled")">Cancelled</option>
                            </select>
                        </div>

                        <div class="vr text-secondary opacity-25"></div>

                        <div class="d-flex align-items-center">
                            <label class="small fw-bold text-muted me-2">Payment:</label>
                            <select name="payStatus" class="form-select form-select-sm border-secondary-subtle bg-white" style="width: 120px;" onchange="this.form.submit()">
                                <option value="all" selected="@(currentPay == "all")">All</option>
                                <option value="Paid" selected="@(currentPay == "Paid")">Paid</option>
                                <option value="Partial" selected="@(currentPay == "Partial")">Partial</option>
                                <option value="Unpaid" selected="@(currentPay == "Unpaid")">Unpaid</option>
                            </select>
                        </div>

                        <div class="vr text-secondary opacity-25"></div>

                        <div class="d-flex align-items-center bg-white border border-secondary-subtle rounded px-2 py-1">
                            <label class="small fw-bold text-muted me-2 mb-0">Tk:</label>
                            <input type="number" name="minAmount" value="@currentMin" class="form-control form-control-sm border-0 p-0 text-end" style="width: 60px;" placeholder="Min">
                            <span class="text-muted small mx-1">-</span>
                            <input type="number" name="maxAmount" value="@currentMax" class="form-control form-control-sm border-0 p-0" style="width: 60px;" placeholder="Max">
                            <button type="submit" class="btn btn-sm btn-link text-primary p-0 ms-1" title="Apply Amount Filter">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </div>

                        <div class="vr text-secondary opacity-25"></div>

                        <div class="d-flex align-items-center">
                            <label class="small fw-bold text-muted me-2">Date:</label>
                            <select id="dateRangeSelect" name="dateRange" class="form-select form-select-sm border-secondary-subtle bg-white" style="width: 120px;" onchange="handleDateChange(this)">
                                <option value="all" selected="@(currentDate == "all")">All Time</option>
                                <option value="today" selected="@(currentDate == "today")">Today</option>
                                <option value="yesterday" selected="@(currentDate == "yesterday")">Yesterday</option>
                                <option value="thisWeek" selected="@(currentDate == "thisWeek")">This Week</option>
                                <option value="lastWeek" selected="@(currentDate == "lastWeek")">Last Week</option>
                                <option value="thisMonth" selected="@(currentDate == "thisMonth")">This Month</option>
                                <option value="lastMonth" selected="@(currentDate == "lastMonth")">Last Month</option>
                                <option value="custom" selected="@(currentDate == "custom")">Custom...</option>
                            </select>
                        </div>

                        <div id="customDateInputs" class="@customDateClass align-items-center gap-2 bg-white p-1 rounded border shadow-sm">
                            <input type="date" name="fromDate" value="@ViewData["CurrentFromDate"]" class="form-control form-control-sm border-0" style="width: 110px;" />
                            <span class="text-muted small">-</span>
                            <input type="date" name="toDate" value="@ViewData["CurrentToDate"]" class="form-control form-control-sm border-0" style="width: 110px;" />
                            <button type="submit" class="btn btn-sm btn-primary py-0 px-2">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>

                        @if (isFiltered)
                        {
                            <div class="ms-2">
                                <a href="/order/all?pageSize=@Model.PageSize" class="text-danger text-decoration-none small fw-bold">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        }
                    </form>
                </div>
            </div>
        </div>
    </div>

    @if (ViewData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mb-3" role="alert">
            @ViewData["ErrorMessage"]
        </div>
    }

    <div class="glass-card-fill">
        <div class="table-scroll-lock">
            <table class="table table-hover mb-0 align-middle products-table" id="ordersTable">
                <thead>
                    <tr>
                        <th style="width: 30px;" class="text-center">
                            <input type="checkbox" class="form-check-input" id="checkAllRows">
                        </th>
                        <th style="width: 40px;"></th>
                        <th style="width: 40px;"></th>
                        <th>ID</th>
                        <th>Order Type</th>
                        <th>Order Date</th>
                        <th>Net Amount</th>
                        <th class="text-success">Paid</th>
                        <th class="text-danger">Due</th>
                        <th>Status</th>
                        <th>Confirmed</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Orders != null && Model.Orders.Any())
                    {
                        foreach (var order in Model.Orders)
                        {
                            string collapseId = "collapse_" + order.Id;
                            string orderIdDisplay = order.SalesOrderId ?? order.Id.ToString();
                            string orderType = order.SalesChannelId == 1 ? "Online" : "Direct";
                            string displayStatus = order.Status == "Draft" ? "Pending" : order.Status;
                            bool isToggleDisabled = order.Status == "Cancelled" || order.Status == "Delivered" || order.Status == "Returned" || order.Status == "Shipped";

                            string statusBadgeClass = "bg-secondary-subtle text-dark";
                            if (order.Status == "Confirmed") statusBadgeClass = "bg-success text-white";
                            else if (order.Status == "Pending" || order.Status == "Draft") statusBadgeClass = "bg-warning text-dark";
                            else if (order.Status == "Cancelled") statusBadgeClass = "bg-danger text-white";
                            else if (order.Status == "Delivered") statusBadgeClass = "bg-primary text-white";

                            string paymentStatusTag = "Unpaid";
                            if (order.DueAmount <= 0) { paymentStatusTag = "Paid"; }
                            else if (order.PaidAmount > 0) { paymentStatusTag = "Partial"; }

                            <tr class="accordion-toggle order-row-item" style="cursor: pointer;"
                                id="order-row-@order.Id"
                                data-order-status="@displayStatus"
                                data-pay-status="@paymentStatusTag"
                                onclick="document.getElementById('btn-@order.Id').click()">

                                <td class="text-center" onclick="event.stopPropagation();">
                                    <input type="checkbox" class="form-check-input row-checkbox" value="@order.Id">
                                </td>
                                <td onclick="event.stopPropagation();"></td>
                                <td onclick="event.stopPropagation();">
                                    <button class="btn btn-sm btn-link text-decoration-none text-dark p-0 transition-icon"
                                            type="button" id="btn-@order.Id" data-bs-toggle="collapse" data-bs-target="#@collapseId">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </td>
                                <td class="fw-bold text-maroon">@orderIdDisplay</td>
                                <td>@orderType</td>
                                <td class="small">
                                    <span class="utc-date" data-utc="@order.OrderDate.ToUtcString()">
                                        @FormatDate(order.OrderDate)
                                    </span>
                                </td>
                                <td class="fw-bold">Tk. @FormatAmount(order.NetAmount)</td>
                                <td class="text-success fw-bold">
                                    @if (order.PaidAmount > 0)
                                    {
                                        <span>Tk. @FormatAmount(order.PaidAmount)</span>
                                    }
                                    else
                                    {

                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td class="text-danger fw-bold">
                                    @if (order.DueAmount > 0)
                                    {
                                        <span>Tk. @FormatAmount(order.DueAmount)</span>
                                    }
                                    else
                                    {

                                        <span class="badge bg-success-subtle text-success border border-success-subtle">Paid</span>
                                    }
                                </td>
                                <td>
                                    <span id="status-badge-@order.Id" class="badge @statusBadgeClass">@displayStatus</span>
                                </td>
                                <td onclick="event.stopPropagation();">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input confirm-toggle" type="checkbox" id="toggle-@order.Id" data-id="@order.Id"
                                               @(order.Confirmed ? "checked" : "") @(isToggleDisabled ? "disabled" : "")>
                                    </div>
                                </td>
                            </tr>

                            <tr class="collapse bg-light shadow-sm order-details-row" id="@collapseId" data-parent-row-id="@order.Id">
                                <td colspan="9" class="p-3 bg-light">
                                    <div class="d-flex align-items-center gap-3 ps-3">
                                        <span class="text-uppercase small fw-bold text-muted">Actions:</span>
                                        @{
                                            var addrParts = new List<string>();
                                            if (!string.IsNullOrWhiteSpace(order.Country)) addrParts.Add(order.Country);
                                            if (!string.IsNullOrWhiteSpace(order.Divison)) addrParts.Add(order.Divison);
                                            if (!string.IsNullOrWhiteSpace(order.City)) addrParts.Add(order.City);
                                            if (!string.IsNullOrWhiteSpace(order.Thana)) addrParts.Add(order.Thana);
                                            if (!string.IsNullOrWhiteSpace(order.SubOffice)) addrParts.Add(order.SubOffice);
                                            if (!string.IsNullOrWhiteSpace(order.Street)) addrParts.Add(order.Street);
                                            if (!string.IsNullOrWhiteSpace(order.PostalCode)) addrParts.Add(order.PostalCode);
                                            string fullAddress = string.Join(", ", addrParts);
                                        }

                                        <button type="button" class="btn btn-sm btn-white border shadow-sm"
                                                id="btn-view-@order.Id" 
                                                data-bs-toggle="modal" data-bs-target="#detailsModal"
                                                data-id="@orderIdDisplay" data-status="@displayStatus" data-type="@orderType"
                                                data-cust-id="@order.CustomerId"
                                                data-cust-name="@order.CustomerName" data-cust-phone="@(order.CustomerPhone ?? "N/A")"
                                                data-addr-id="@(order.AddressId == 0 ? "N/A" : order.AddressId.ToString())"
                                                data-full-addr="@fullAddress" data-total="@FormatAmount(order.TotalAmount)"
                                                data-net="@FormatAmount(order.NetAmount)"
                                                data-discount="@FormatAmount(order.TotalAmount - order.NetAmount)"
                                                data-created-by="@(order.CreatedBy ?? "System")"
                                                data-created-at="@order.CreatedAt.ToUtcString()"
                                                data-updated-at="@order.UpdatedAt.ToUtcString()"
                                                data-updated-by="@(order.UpdatedBy ?? "-")"
                                                data-ip="@(order.IPAddress ?? "N/A")" data-session="@(order.SessionId ?? "N/A")">
                                            <i class="fas fa-eye text-primary me-1"></i> View Details
                                        </button>

                                        <button type="button" class="btn btn-sm btn-white border shadow-sm" onclick="openAdvanceModal(this)"
                                                data-order-id="@order.Id" data-order-ref="@orderIdDisplay" data-cust-id="@order.CompanyCustomerId"
                                                data-net="@FormatRaw(order.NetAmount)" data-paid="@FormatRaw(order.PaidAmount)"
                                                data-delivery="@FormatRaw(order.DeliveryCharge)"
                                                data-product-price="@FormatRaw(order.TotalAmount - order.DeliveryCharge)"
                                                data-discount="@FormatRaw(order.DiscountAmount)">
                                            <i class="fas fa-money-bill-wave text-success me-1"></i> Add Advance Payment
                                        </button>
                                        <button type="button" class="btn btn-sm btn-white border shadow-sm ms-1"
                                                onclick="openHistoryModal(@order.Id)" title="View Order History">
                                            <i class="fas fa-list-ul text-secondary"></i>
                                        </button>
                                        @if (order.Status != "Cancelled" && order.Status != "Delivered" && order.Status != "Returned" && order.Status != "Confirmed")
                                        {
                                            <button type="button" class="btn btn-sm btn-white border shadow-sm text-danger"
                                                    id="btn-cancel-@order.Id" onclick="cancelOrder(@order.Id, '@orderIdDisplay')" title="Cancel this order">
                                                <i class="fas fa-times-circle me-1"></i> Cancel
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center p-5 text-muted">
                                <i class="fas fa-inbox fa-2x mb-3 opacity-50"></i>
                                <div>No orders found.</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Model.TotalPages > 0)
        {
            <div class="d-flex justify-content-between align-items-center p-3 bg-white border-top position-relative mt-5">
                <div class="d-flex align-items-center gap-2" style="z-index: 10;">
                    <div class="d-flex align-items-center bg-light border border-secondary-subtle rounded px-2 py-1 shadow-sm" style="height: 31px;">
                        <span class="small fw-bold text-muted me-2">Rows:</span>
                        <select id="footer-page-size" class="form-select form-select-sm border-0 bg-transparent py-0" style="width: auto; cursor: pointer; box-shadow: none;" onchange="changePageSize(this)">
                            <option value="5" selected="@(Model.PageSize == 5)">5</option>
                            <option value="10" selected="@(Model.PageSize == 10)">10</option>
                            <option value="20" selected="@(Model.PageSize == 20)">20</option>
                            <option value="50" selected="@(Model.PageSize == 50)">50</option>
                            <option value="100" selected="@(Model.PageSize == 100)">100</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm shadow-sm" style="width: 130px;">
                        <span class="input-group-text bg-light border-secondary-subtle">Page</span>
                        <input type="number" id="jump-page-input" class="form-control border-secondary-subtle text-center px-1"
                               min="1" max="@Model.TotalPages" value="@Model.CurrentPage" onkeypress="handleEnter(event)">
                        <button class="btn btn-outline-secondary border-secondary-subtle" type="button" onclick="jumpToPage()">Go</button>
                    </div>
                </div>
                <div class="position-absolute top-50 start-50 translate-middle text-muted small fw-bold" style="z-index: 0;">
                    (Page @Model.CurrentPage of @Model.TotalPages)
                </div>
                <nav style="z-index: 10;">
                    <ul class="pagination pagination-sm mb-0 shadow-sm">
                        <li class="page-item @(Model.HasPrevious ? "" : "disabled")">
                            <a class="page-link" href="/order/all?page=@(Model.CurrentPage - 1)&pageSize=@Model.PageSize&status=@ViewData["CurrentStatus"]&payStatus=@ViewData["CurrentPayStatus"]&orderType=@ViewData["CurrentOrderType"]&dateRange=@ViewData["CurrentDateRange"]&minAmount=@ViewData["CurrentMinAmount"]&maxAmount=@ViewData["CurrentMaxAmount"]&search=@ViewData["CurrentSearch"]"><i class="fas fa-chevron-left"></i></a>
                        </li>
                        @{
                            int startPage = Math.Max(2, Model.CurrentPage - 2);
                            int endPage = Math.Min(Model.TotalPages - 1, Model.CurrentPage + 2);
                        }
                        <li class="page-item @(1 == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="/order/all?page=1&pageSize=@Model.PageSize&status=@ViewData["CurrentStatus"]&payStatus=@ViewData["CurrentPayStatus"]&orderType=@ViewData["CurrentOrderType"]&dateRange=@ViewData["CurrentDateRange"]&minAmount=@ViewData["CurrentMinAmount"]&maxAmount=@ViewData["CurrentMaxAmount"]&search=@ViewData["CurrentSearch"]">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link text-muted">...</span></li>
                        }
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="/order/all?page=@i&pageSize=@Model.PageSize&status=@ViewData["CurrentStatus"]&payStatus=@ViewData["CurrentPayStatus"]&orderType=@ViewData["CurrentOrderType"]&dateRange=@ViewData["CurrentDateRange"]&minAmount=@ViewData["CurrentMinAmount"]&maxAmount=@ViewData["CurrentMaxAmount"]&search=@ViewData["CurrentSearch"]">@i</a>
                            </li>
                        }
                        @if (endPage < Model.TotalPages - 1)
                        {
                            <li class="page-item disabled"><span class="page-link text-muted">...</span></li>
                        }
                        @if (Model.TotalPages > 1)
                        {
                            <li class="page-item @(Model.TotalPages == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="/order/all?page=@Model.TotalPages&pageSize=@Model.PageSize&status=@ViewData["CurrentStatus"]&payStatus=@ViewData["CurrentPayStatus"]&orderType=@ViewData["CurrentOrderType"]&dateRange=@ViewData["CurrentDateRange"]&minAmount=@ViewData["CurrentMinAmount"]&maxAmount=@ViewData["CurrentMaxAmount"]&search=@ViewData["CurrentSearch"]">@Model.TotalPages</a>
                            </li>
                        }
                        <li class="page-item @(Model.HasNext ? "" : "disabled")">
                            <a class="page-link" href="/order/all?page=@(Model.CurrentPage + 1)&pageSize=@Model.PageSize&status=@ViewData["CurrentStatus"]&payStatus=@ViewData["CurrentPayStatus"]&orderType=@ViewData["CurrentOrderType"]&dateRange=@ViewData["CurrentDateRange"]&minAmount=@ViewData["CurrentMinAmount"]&maxAmount=@ViewData["CurrentMaxAmount"]&search=@ViewData["CurrentSearch"]"><i class="fas fa-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="advanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fs-6 fw-bold">Add Advance Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="advanceForm">
                    <input type="hidden" id="adv_orderId" name="OrderId" />
                    <input type="hidden" id="adv_customerId" name="CustomerId" />
                    <input type="hidden" id="adv_orderRef" name="TransactionReference" />

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Product Price</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0">Tk</span>
                                <input type="text" id="adv_productPrice" class="form-control fw-bold bg-light" readonly disabled />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Discount</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0 text-danger">- Tk</span>
                                <input type="text" id="adv_discount" class="form-control fw-bold text-danger bg-light" readonly disabled />
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Total Payable</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0">Tk</span>
                                <input type="text" id="adv_netAmount" class="form-control fw-bold bg-white" readonly />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Delivery Charge <span class="text-danger">*</span></label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0">Tk</span>
                                <input type="number" id="adv_delivery" class="form-control fw-bold" value="0" />
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mb-3 p-2 bg-light rounded border mx-0">
                        <div class="col-6">
                            <label class="form-label small text-muted mb-0">Already Paid</label>
                            <div class="fw-bold text-success fs-6">Tk <span id="adv_displayPaid">0.00</span></div>
                            <input type="hidden" id="adv_alreadyPaid" value="0" />
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted mb-0">Current Due</label>
                            <div class="fw-bold text-danger fs-6">Tk <span id="adv_displayCurrentDue">0.00</span></div>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Method <span class="text-danger">*</span></label>
                            <select id="adv_paymentMethod" name="PaymentMethodId" class="form-select form-select-sm" required>
                                @if (ViewBag.PaymentMethods != null)
                                {
                                    foreach (var pm in ViewBag.PaymentMethods)
                                    {
                                        <option value="@pm.PaymentMethodId">@pm.MethodName</option>
                                    }
                                }
                                else
                                {
                                    <option value="1">Cash</option>
                                }
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Type <span class="text-danger">*</span></label>
                            <select id="adv_paymentType" name="PaymentType" class="form-select form-select-sm">
                                <option value="Advance">Advance (Partial)</option>
                                <option value="Sale">Sale (Full Payment)</option>
                            </select>
                        </div>
                    </div>
                    <hr class="text-muted my-2 opacity-25">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Amount Paying Now <span class="text-danger">*</span></label>
                        <div class="input-group has-validation">
                            <span class="input-group-text bg-success text-white">Tk</span>
                            <input type="number" id="adv_paidAmount" name="Amount" class="form-control fw-bold fs-5" placeholder="0.00" required />
                            <div id="adv_amountError" class="invalid-feedback fw-bold">Amount cannot exceed Due.</div>
                        </div>
                    </div>
                    <div class="mb-3 p-2 bg-danger-subtle rounded border border-danger-subtle d-flex justify-content-between align-items-center">
                        <span class="text-danger fw-medium small">Balance After Payment:</span>
                        <span class="text-danger fw-bold fs-5">Tk <span id="adv_dueAmount">0.00</span></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Note / Remarks <span id="adv_note_star" class="text-danger d-none">*</span></label>
                        <textarea id="adv_note" name="Notes" class="form-control form-control-sm" rows="2" placeholder="e.g. Bkash Trx ID..."></textarea>
                    </div>
                    <button type="submit" id="adv_submitBtn" class="btn btn-success w-100 fw-medium">Save Payment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fs-6 fw-bold">
                    <i class="fas fa-history text-primary me-2"></i>Order Audit History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="historyModalBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 small text-muted">Loading history...</div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable order-details-modal">
        <div class="modal-content">
            <div class="modal-header modal-header-soft">
                <h5 class="modal-title" id="detailsModalLabel">Order <span id="m-id" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="info-section status-section">
                    <div class="section-header"><span>Order Status</span></div>
                    <div class="section-content"><h4 id="m-status" class="mb-0"></h4></div>
                </div>
                <div class="info-section">
                    <div class="section-header"><span>General Information</span></div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Order Type</span><span class="info-value" id="m-type"></span></div>
                            <div class="info-item"><span class="info-label">Customer ID</span><span class="info-value" id="m-cust-id"></span></div>
                            <div class="info-item"><span class="info-label">Phone</span><span class="info-value" id="m-cust-phone"></span></div>
                            <div class="info-item"><span class="info-label">Address ID</span><span class="info-value" id="m-addr-id"></span></div>
                        </div>
                    </div>
                </div>
                <div class="info-section financial-section">
                    <div class="section-header"><span>Financial Breakdown</span></div>
                    <div class="section-content">
                        <div class="finance-grid">
                            <div class="finance-item"><span class="finance-label">Total Amount</span><span class="finance-value">Tk. <span id="m-total"></span></span></div>
                            <div class="finance-item discount"><span class="finance-label">Discount</span><span class="finance-value">- Tk. <span id="m-discount"></span></span></div>
                            <div class="finance-item net"><span class="finance-label">Net Amount</span><span class="finance-value">Tk. <span id="m-net"></span></span></div>
                        </div>
                    </div>
                </div>
                <div class="info-section">
                    <div class="section-header"><span>System & Audit</span></div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Created By</span><span class="info-value" id="m-created-by"></span></div>
                            <div class="info-item"><span class="info-label">Created At</span><span class="info-value" id="m-created-at"></span></div>
                            <div class="info-item"><span class="info-label">Updated By</span><span class="info-value" id="m-updated-by"></span></div>
                            <div class="info-item"><span class="info-label">Updated At</span><span class="info-value" id="m-updated-at"></span></div>
                        </div>
                    </div>
                </div>
                <div class="info-section">
                    <div class="section-header"><span>Technical Data</span></div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">IP Address</span><span class="info-value code" id="m-ip"></span></div>
                            <div class="info-item full-width"><span class="info-label">Session ID</span><span class="info-value code" id="m-session"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    var orderColumns = new Dictionary<string, string> {
        {"Id", "Order ID"}, {"OrderDate", "Order Date"}, {"CustomerName", "Customer Name"},
        {"CustomerPhone", "Phone"}, {"TotalAmount", "Total Amount"}, {"Status", "Status"},
        {"PaymentStatus", "Payment Status"}, {"ShippingAddress", "Address"},{ "Paid", "Paid Amount" },
        { "Due", "Due Amount" }
    };
}

@await Html.PartialAsync("_GenericExportModal", orderColumns)

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/order-details.js" asp-append-version="true"></script>
    <script src="~/js/order-actions.js" asp-append-version="true"></script>
    <script src="~/js/export.js" asp-append-version="true"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Search Debounce
            let searchTimeout = null;
            const headerSearch = document.getElementById('headerSearchInput');
            const formSearch = document.getElementById('formSearchInput');
            const form = document.getElementById('filterForm');

            if (headerSearch) {
                headerSearch.addEventListener('keyup', function() {
                    clearTimeout(searchTimeout);
                    formSearch.value = this.value;
                    searchTimeout = setTimeout(function() {
                        form.submit();
                    }, 500);
                });
            }

            // Highlight Logic
            const urlParams = new URLSearchParams(window.location.search);
            const highlightId = urlParams.get('highlightId');
            if (highlightId) {
                const targetRow = document.getElementById('order-row-' + highlightId);
                if (targetRow) {
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetRow.classList.add('row-highlight');
                    const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.search;
                    window.history.replaceState({ path: newUrl }, '', newUrl);
                }
            }
            const tableBody = document.querySelector('tbody');
            if (tableBody) {
                tableBody.addEventListener('click', function(e) {
                    const highlightedRow = document.querySelector('.row-highlight');
                    if (highlightedRow) highlightedRow.classList.remove('row-highlight');
                });
            }
        });

        // Cancel Order Override
        window.cancelOrder = function(orderId, orderDisplayId) {
            Swal.fire({
                title: 'Cancel Order?',
                text: `Are you sure you want to cancel ${orderDisplayId}? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Cancel it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Processing...', didOpen: () => { Swal.showLoading() } });
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    const formData = new URLSearchParams();
                    formData.append('id', orderId);
                    formData.append('status', 'Cancelled');

                    fetch('/SalesOrder/UpdateStatus', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                        body: formData.toString()
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Cancelled!', 'Order has been cancelled.', 'success');
                            const badge = document.getElementById(`status-badge-${orderId}`);
                            if (badge) { badge.textContent = "Cancelled"; badge.className = "badge bg-danger text-white"; }
                            const cancelBtn = document.getElementById(`btn-cancel-${orderId}`);
                            if (cancelBtn) cancelBtn.remove();
                            const toggle = document.getElementById(`toggle-${orderId}`);
                            if (toggle) { toggle.disabled = true; toggle.checked = false; }
                            const row = document.getElementById(`order-row-${orderId}`);
                            if (row) { row.setAttribute('data-order-status', 'Cancelled'); row.classList.add('row-highlight'); }
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    }).catch(err => Swal.fire('Error', 'Network Error.', 'error'));
                }
            });
        };

        function changePageSize(select) {
            const params = new URLSearchParams(window.location.search);
            params.set('pageSize', select.value);
            params.set('page', 1);
            window.location.search = params.toString();
        }

        function jumpToPage() {
            const input = document.getElementById('jump-page-input');
            const params = new URLSearchParams(window.location.search);
            params.set('page', input.value);
            window.location.search = params.toString();
        }

        function handleEnter(e) { if (e.key === 'Enter') jumpToPage(); }

        function handleDateChange(select) {
            const customInputs = document.getElementById('customDateInputs');
            if (select.value === 'custom') {
                customInputs.classList.remove('d-none'); customInputs.classList.add('d-flex');
            } else {
                customInputs.classList.add('d-none'); customInputs.classList.remove('d-flex');
                document.getElementById('filterForm').submit();
            }
        }
    </script>
}

@functions {
    public string FormatDate(DateTime? date)
    {
        if (!date.HasValue || date.Value == DateTime.MinValue) return "N/A";
        return date.Value.ToString("MMM dd, yyyy");
    }
    public string FormatAmount(decimal? amount)
    {
        if (!amount.HasValue || amount.Value == 0M) return "0.00";
        return amount.Value.ToString("N2");
    }
    public string FormatRaw(decimal? amount)
    {
        if (!amount.HasValue) return "0";
        return amount.Value.ToString("0.##");
    }
}