@{
    ViewData["Title"] = "Security Settings";
    Layout = "_AdminLayout";
    bool isEnabled = ViewBag.IsTwoFactorEnabled ?? false;
}

<div class="container-fluid p-4">
    <h3 class="mb-4 fw-bold text-dark">Security Configuration</h3>

    <div class="row">
        <div class="col-lg-6">
            <div class="card border shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold mb-3"><i class="fas fa-shield-alt text-primary me-2"></i> Two-Factor Authentication</h5>

                    @if (isEnabled)
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                            <h4 class="mt-3 text-success fw-bold">2FA is Enabled</h4>
                            <p class="text-muted">Your account is secure.</p>
                            <button class="btn btn-outline-danger btn-sm" disabled>Disable (Contact Admin)</button>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small">Scan this QR code with <strong>Google Authenticator</strong> app.</p>

                        <div class="text-center mb-3">
                            <img src="@ViewBag.QrCodeImage" alt="QR Code" class="img-thumbnail" style="width: 200px; height: 200px;">
                        </div>

                        <div class="text-center mb-3">
                            <small class="text-muted">Manual Key:</small>
                            <code class="fw-bold d-block">@ViewBag.ManualEntryKey</code>
                        </div>

                        <form id="enable2faForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="entryKey" value="@ViewBag.ManualEntryKey">

                            <div class="input-group mb-3">
                                <input type="text" name="code" class="form-control text-center" placeholder="Enter 6-digit Code" maxlength="6" required>
                                <button class="btn btn-primary" type="submit">Verify & Enable</button>
                            </div>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $('#enable2faForm').submit(function(e) {
            e.preventDefault();
            var data = $(this).serialize();

            $.post('@Url.Action("EnableTwoFactor", "Settings")', data, function(res) {
                if (res.success) {
                    Swal.fire('Success', res.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            });
        });
    </script>
}