@{
    ViewData["Title"] = "Email Templates";
    Layout = "_AdminLayout";

}

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Email Templates Manager</h2>
        <button class="btn btn-primary" onclick="openModal()">
            <i class="fa fa-plus"></i> New Template
        </button>
    </div>

    <table class="table table-bordered table-hover" id="templateTable">
        <thead class="thead-dark">
            <tr>
                <th>Key</th>
                <th>Subject</th>
                <th>From</th>
                <th>To</th>
                <th style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div class="modal fade" id="editorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Email Template</h5>
                <button type="button" class="close" data-dismiss="modal" onclick="$('#editorModal').modal('hide')">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <input type="hidden" id="Id" name="Id" value="0" />

                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label>Template Key <small class="text-muted">(Code Reference)</small></label>
                            <input type="text" class="form-control" id="TemplateKey" name="TemplateKey" required />
                        </div>
                        <div class="col-md-6 form-group">
                            <label>Subject</label>
                            <input type="text" class="form-control" id="Subject" name="Subject" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label>From Name</label>
                            <input type="text" class="form-control" id="FromName" name="FromName" placeholder="MDUA Support" />
                        </div>
                        <div class="col-md-6 form-group">
                            <label>From Email</label>
                            <input type="text" class="form-control" id="FromEmail" name="FromEmail" placeholder="support@mdua.com" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 form-group">
                            <label>To Email</label>
                            <input type="text" class="form-control" id="ToEmail" name="ToEmail" placeholder="##ToEmail##" />
                        </div>
                        <div class="col-md-4 form-group">
                            <label>CC</label>
                            <input type="text" class="form-control" id="CcEmail" name="CcEmail" />
                        </div>
                        <div class="col-md-4 form-group">
                            <label>BCC</label>
                            <input type="text" class="form-control" id="BccEmail" name="BccEmail" />
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="d-flex justify-content-between align-items-center">
                            <label>Body Content (HTML)</label>
                            <button type="button" class="btn btn-sm btn-outline-info mb-1" onclick="previewFromEditor()">
                                <i class="fa fa-eye"></i> Preview Design
                            </button>
                        </div>
                        <textarea class="form-control" id="BodyContent" name="BodyContent" rows="12" style="font-family: monospace; font-size: 12px;"></textarea>
                        <small class="text-muted">
                            <b>Variables:</b> Use ##VariableName## (e.g., ##UserName##, ##OrderTotal##).<br />
                            <b>Logic:</b> ##If--IsRegistered## content ##Else## other ##EndIf--IsRegistered##
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="$('#editorModal').modal('hide')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="fa fa-desktop"></i> HTML Preview
                </h5>
                <button type="button" class="close" onclick="$('#previewModal').modal('hide')">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="background-color: #e9ecef; padding: 20px;">
                <div class="card shadow-sm mx-auto" style="max-width: 800px;">
                    <div class="card-body p-0">
                        <iframe id="previewFrame" style="width: 100%; height: 600px; border: none;"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script>
        $(document).ready(function () {
            loadTemplates();
                // --- ADD THIS FIX FOR THE NESTED MODAL Z-INDEX ---
        $('#previewModal').on('show.bs.modal', function () {
            // 1. Set the z-index of the modal itself high
            var zIndex = 1060;
            $(this).css('z-index', zIndex);

            // 2. Wait 10ms for Bootstrap to generate the backdrop,
            // then find the *last* backdrop added (the new one) and push its z-index up
            setTimeout(function() {
                $('.modal-backdrop').last().css('z-index', zIndex - 1);
            }, 10);
        });
        });

        // 1. LOAD GRID
        function loadTemplates() {
            $.get('/EmailTemplate/GetAllTemplates', function (res) {
                if (res.success) {
                    var rows = '';
                    $.each(res.data, function (i, item) {
                        rows += `<tr>
                            <td class="align-middle"><b>${item.templateKey}</b></td>
                            <td class="align-middle">${item.subject}</td>
                            <td class="align-middle">${item.fromName}</td>
                            <td class="align-middle">${item.toEmail}</td>
                            <td class="text-center align-middle" style="white-space: nowrap;">
                                <button class="btn btn-sm btn-outline-secondary mr-1" onclick="previewFromGrid(${item.id})" title="Quick Preview">
                                    <i class="fa fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-info mr-1" onclick="editTemplate(${item.id})" title="Edit">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${item.id})" title="Delete">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                    });
                    $('#templateTable tbody').html(rows);
                }
            });
        }

        // 2. OPEN NEW MODAL
        function openModal() {
            $('#templateForm')[0].reset();
            $('#Id').val(0);
            $('#TemplateKey').prop('readonly', false); // Allow editing key for new
            $('#editorModal').modal('show');
        }

        // 3. EDIT ACTION
        function editTemplate(id) {
            $.get('/EmailTemplate/GetById?id=' + id, function (res) {
                if (res.success) {
                    var d = res.data;
                    $('#Id').val(d.id);
                    $('#TemplateKey').val(d.templateKey).prop('readonly', true); // Lock key on edit
                    $('#Subject').val(d.subject);
                    $('#FromName').val(d.fromName);
                    $('#FromEmail').val(d.fromEmail);
                    $('#ToEmail').val(d.toEmail);
                    $('#CcEmail').val(d.ccEmail);
                    $('#BccEmail').val(d.bccEmail);
                    $('#BodyContent').val(d.bodyContent);

                    $('#editorModal').modal('show');
                }
            });
        }

        // 4. DELETE ACTION
        function deleteTemplate(id) {
            if (confirm('Are you sure you want to delete this template? This cannot be undone.')) {
                $.post('/EmailTemplate/Delete', { id: id }, function (res) {
                    if (res.success) {
                        loadTemplates(); // Refresh grid
                    } else {
                        alert('Error: ' + res.message);
                    }
                });
            }
        }

        // 5. PREVIEW FROM GRID (No need to open Edit modal first)
        function previewFromGrid(id) {
            // Fetch content first
            $.get('/EmailTemplate/GetById?id=' + id, function (res) {
                if (res.success) {
                    renderPreview(res.data.bodyContent);
                }
            });
        }

        // 6. PREVIEW FROM EDITOR
        function previewFromEditor() {
            var rawHtml = $('#BodyContent').val();
            if (!rawHtml) {
                alert("Please enter some HTML first.");
                return;
            }
            renderPreview(rawHtml);
        }

        // Helper to render HTML in Iframe
        function renderPreview(htmlContent) {
            $('#previewModal').modal('show');
            var iframe = document.getElementById('previewFrame');
            var doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(htmlContent);
            doc.close();
        }

        // 7. SAVE
        function saveTemplate() {
            var data = $('#templateForm').serialize();
            $.post('/EmailTemplate/Save', data, function (res) {
                if (res.success) {
                    $('#editorModal').modal('hide');
                    loadTemplates();
                    alert('Saved Successfully');
                } else {
                    alert('Error: ' + res.message);
                }
            });
        }
    </script>
}