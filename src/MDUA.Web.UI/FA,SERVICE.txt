Dusing MDUA.DataAccess;
using MDUA.DataAccess.Interface;
using MDUA.Entities;
using MDUA.Entities.Bases;
using MDUA.Entities.List;
using MDUA.Facade.Interface;
using MDUA.Framework;
using System;
using System.Collections.Generic;
using System.Data.SqlClient;             // Required for SqlConnection
using Microsoft.Extensions.Configuration; // ✅ Required for appsettings.json access

namespace MDUA.Facade
{
    public class OrderFacade : IOrderFacade
    {
        private readonly ISalesOrderHeaderDataAccess _salesOrderHeaderDataAccess;
        private readonly ISalesOrderDetailDataAccess _salesOrderDetailDataAccess;
        private readonly ICustomerDataAccess _customerDataAccess;
        private readonly ICompanyCustomerDataAccess _companyCustomerDataAccess;
        private readonly IAddressDataAccess _addressDataAccess;
        private readonly IProductVariantDataAccess _productVariantDataAccess;
        private readonly IProductFacade _productFacade;
        private readonly IPostalCodesDataAccess _postalCodesDataAccess;
        private readonly ISettingsFacade _settingsFacade;

        // ✅ 1. Declare Configuration to access appsettings.json
        private readonly IConfiguration _configuration;
        private readonly IDeliveryDataAccess _deliveryDataAccess;
        public OrderFacade(
            ISalesOrderHeaderDataAccess salesOrderHeaderDataAccess,
            ISalesOrderDetailDataAccess salesOrderDetailDataAccess,
            ICustomerDataAccess customerDataAccess,
            ICompanyCustomerDataAccess companyCustomerDataAccess,
            IAddressDataAccess addressDataAccess,
            IProductVariantDataAccess productVariantDataAccess,
            IProductFacade productFacade,
            IPostalCodesDataAccess postalCodesDataAccess,

            IConfiguration configuration
            ,
            ISettingsFacade settingsFacade,
            IDeliveryDataAccess deliveryDataAccess)
        {
            _salesOrderHeaderDataAccess = salesOrderHeaderDataAccess;
            _salesOrderDetailDataAccess = salesOrderDetailDataAccess;
            _customerDataAccess = customerDataAccess;
            _companyCustomerDataAccess = companyCustomerDataAccess;
            _addressDataAccess = addressDataAccess;
            _productVariantDataAccess = productVariantDataAccess;
            _productFacade = productFacade;
            _postalCodesDataAccess = postalCodesDataAccess;
            _configuration = configuration;
            _settingsFacade = settingsFacade;
            _deliveryDataAccess = deliveryDataAccess;

        }

        #region Common Implementation
        public long Delete(int id) => _salesOrderHeaderDataAccess.Delete(id);
        public SalesOrderHeader Get(int id) => _salesOrderHeaderDataAccess.Get(id);
        public SalesOrderHeaderList GetAll() => _salesOrderHeaderDataAccess.GetAll();
        public SalesOrderHeaderList GetByQuery(string query) => _salesOrderHeaderDataAccess.GetByQuery(query);
        public long Insert(SalesOrderHeaderBase obj) => _salesOrderHeaderDataAccess.Insert(obj);
        public long Update(SalesOrderHeaderBase obj) => _salesOrderHeaderDataAccess.Update(obj);
        #endregion

        #region Extended Implementation

        public Customer GetCustomerByPhone(string phone) => _customerDataAccess.GetByPhone(phone);
        public PostalCodes GetPostalCodeDetails(string code) => _postalCodesDataAccess.GetPostalCodeDetails(code);
        public Customer GetCustomerByEmail(string email) => _customerDataAccess.GetByEmail(email);
        public List<string> GetDivisions() => _postalCodesDataAccess.GetDivisions();

        public List<string> GetDistricts(string division) => _postalCodesDataAccess.GetDistricts(division);

        public List<string> GetThanas(string district) => _postalCodesDataAccess.GetThanas(district);

        public List<dynamic> GetSubOffices(string thana) => _postalCodesDataAccess.GetSubOffices(thana);


        public string PlaceGuestOrder(SalesOrderHeader orderData)
        {
            // ✅ 0. VALIDATION: Ensure Customer Name is present
            if (string.IsNullOrWhiteSpace(orderData.CustomerName))
                throw new Exception("Customer Name is required to place an order.");

            // Clean the input
            orderData.CustomerName = orderData.CustomerName.Trim();

            // 1. PRE-CALCULATION (Read-Only)
            var variant = _productVariantDataAccess.GetWithStock(orderData.ProductVariantId);
            if (variant == null) throw new Exception("Variant not found.");

            if (variant.StockQty == 0)
                throw new Exception("The selected product variant is currently out of stock.");

            if (variant.StockQty < orderData.OrderQuantity)
                throw new Exception($"Requested amount {orderData.OrderQuantity} exceeds available amount {variant.StockQty}.");

            decimal baseVariantPrice = variant.VariantPrice ?? 0;
            int quantity = orderData.OrderQuantity;

            // Discount Calculation
            var bestDiscount = _productFacade.GetBestDiscount(variant.ProductId, baseVariantPrice);
            decimal finalUnitPrice = baseVariantPrice;
            decimal totalDiscountAmount = 0;

            if (bestDiscount != null)
            {
                if (bestDiscount.DiscountType == "Flat")
                {
                    decimal discountPerItem = bestDiscount.DiscountValue;
                    finalUnitPrice -= discountPerItem;
                    totalDiscountAmount = discountPerItem * quantity;
                }
                else if (bestDiscount.DiscountType == "Percentage")
                {
                    decimal discountRate = bestDiscount.DiscountValue / 100;
                    decimal discountPerItem = baseVariantPrice * discountRate;
                    finalUnitPrice -= discountPerItem;
                    totalDiscountAmount = discountPerItem * quantity;
                }
            }

            // ✅ CALCULATION LOGIC FOR COMPUTED COLUMN
            // 1. Calculate Pure Product Cost
            decimal totalProductPrice = baseVariantPrice * quantity;

            // 2. Add Delivery to Total (This hacks the DB to make NetAmount correct)
            decimal deliveryCharge = orderData.DeliveryCharge; // Captured from UI
            orderData.TotalAmount = totalProductPrice + deliveryCharge;
            orderData.DiscountAmount = totalDiscountAmount;

            // 2. TRANSACTIONAL SAVE
            string connectionString = _configuration.GetConnectionString("DefaultConnection");

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();
                using (SqlTransaction transaction = connection.BeginTransaction())
                {
                    try
                    {
                        var transCustomerDA = new CustomerDataAccess(transaction);
                        var transCompanyCustomerDA = new CompanyCustomerDataAccess(transaction);
                        var transAddressDA = new AddressDataAccess(transaction);
                        var transOrderDA = new SalesOrderHeaderDataAccess(transaction);
                        var transDetailDA = new SalesOrderDetailDataAccess(transaction);

                        int companyId = orderData.TargetCompanyId;
                        int customerId = 0;

                        // A. Customer Logic
                        var customer = transCustomerDA.GetByPhone(orderData.CustomerPhone);
                        if (customer == null)
                        {
                            string emailToCheck = !string.IsNullOrEmpty(orderData.CustomerEmail)
                                ? orderData.CustomerEmail
                                : $"{orderData.CustomerPhone}@guest.local";

                            if (transCustomerDA.GetByEmail(emailToCheck) != null)
                                throw new Exception($"Email {emailToCheck} is already registered.");

                            var newCust = new Customer
                            {
                                CustomerName = orderData.CustomerName, // ✅ Use Name Here
                                Phone = orderData.CustomerPhone,
                                Email = emailToCheck,
                                IsActive = true,
                                CreatedAt = DateTime.UtcNow,
                                CreatedBy = orderData.CustomerName, // ✅ Audit: Created by the Guest Name
                            };
                            transCustomerDA.Insert(newCust);
                            customer = transCustomerDA.GetByPhone(orderData.CustomerPhone);
                        }
                        else
                        {
                            bool needUpdate = false;

                            // ✅ Update Logic: If existing customer has no name, update it with current name
                            if (string.IsNullOrEmpty(customer.CustomerName) || customer.CustomerName == "Unknown")
                            {
                                customer.CustomerName = orderData.CustomerName;
                                needUpdate = true;
                            }

                            if (!string.IsNullOrEmpty(orderData.CustomerEmail) &&
                                customer.Email != orderData.CustomerEmail &&
                                (string.IsNullOrEmpty(customer.Email) || customer.Email.EndsWith("@guest.local")))
                            {
                                customer.Email = orderData.CustomerEmail;
                                needUpdate = true;
                            }

                            if (needUpdate)
                            {
                                customer.UpdatedBy = orderData.CustomerName; // ✅ Audit update
                                customer.UpdatedAt = DateTime.UtcNow;
                                transCustomerDA.Update(customer);
                            }
                        }
                        customerId = customer.Id;

                        // B. Link Logic
                        if (!transCompanyCustomerDA.IsLinked(companyId, customerId))
                        {
                            transCompanyCustomerDA.Insert(new CompanyCustomer { CompanyId = companyId, CustomerId = customerId });
                        }

                        // C. Address Logic
                        var addr = new Address
                        {
                            CustomerId = customerId,
                            Street = orderData.Street,
                            City = orderData.City,
                            Divison = orderData.Divison,
                            Thana = orderData.Thana,
                            SubOffice = orderData.SubOffice,
                            Country = "Bangladesh",
                            AddressType = "Shipping",
                            CreatedBy = orderData.CustomerName, // ✅ Audit: Use Name instead of "System_Order"
                            CreatedAt = DateTime.UtcNow,
                            PostalCode = orderData.PostalCode ?? "0000",
                            ZipCode = (orderData.ZipCode ?? orderData.PostalCode ?? "0000").ToCharArray()
                        };

                        var existingAddress = transAddressDA.CheckExistingAddress(customerId, addr);
                        int addressId = (existingAddress != null) ? existingAddress.Id : (int)transAddressDA.InsertAddressSafe(addr);

                        // D. Save Order Header
                        orderData.CompanyCustomerId = transCompanyCustomerDA.GetId(companyId, customerId);
                        orderData.AddressId = addressId;
                        orderData.SalesChannelId = 1;
                        orderData.OrderDate = DateTime.UtcNow;
                        orderData.Status = "Draft";
                        orderData.IsActive = true;
                        orderData.CreatedBy = orderData.CustomerName; // ✅ Audit: Use Name instead of "System_Order"
                        orderData.CreatedAt = DateTime.UtcNow;
                        orderData.Confirmed = false;

                        // Call InsertSafe (This uses the TotalAmount calculated above)
                        int orderId = (int)transOrderDA.InsertSalesOrderHeaderSafe(orderData);

                        if (orderId <= 0) throw new Exception("Failed to create Order Header.");

                        // E. Save Order Detail
                        var detail = new SalesOrderDetail
                        {
                            SalesOrderId = orderId,
                            ProductVariantId = orderData.ProductVariantId,
                            Quantity = orderData.OrderQuantity,
                            UnitPrice = finalUnitPrice,
                            CreatedBy = orderData.CustomerName, // ✅ Audit: Use Name instead of "System_Order"
                            CreatedAt = DateTime.UtcNow
                        };
                        transDetailDA.InsertSalesOrderDetailSafe(detail);

                        transaction.Commit();
                        return "ON" + orderId.ToString("D8");
                    }
                    catch (Exception)
                    {
                        transaction.Rollback();
                        throw;
                    }
                }
            }
        }
        public (Customer customer, Address address) GetCustomerDetailsForAutofill(string phone)
        {
            var customer = _customerDataAccess.GetByPhone(phone);
            Address address = null;

            if (customer != null)
            {
                address = _addressDataAccess.GetLatestByCustomerId(customer.Id);
            }
            return (customer, address);
        }

        public List<object> GetOrderReceiptByOnlineId(string onlineOrderId)
        {
            if (string.IsNullOrEmpty(onlineOrderId))
            {
                throw new ArgumentException("Online Order ID cannot be null or empty.", nameof(onlineOrderId));
            }
            return _salesOrderHeaderDataAccess.GetOrderReceiptByOnlineId(onlineOrderId);
        }

        // ==========================================================================
        // ✅ 1. CORRECTED: GetAllOrdersForAdmin (Revenue Stability Logic)
        // ==========================================================================
        public List<SalesOrderHeader> GetAllOrdersForAdmin()
        {
            var orders = _salesOrderHeaderDataAccess.GetAllSalesOrderHeaders().ToList();

            foreach (var order in orders)
            {
                // 1. Calculate Sum of Discounted Items (Net Product Total)
                decimal productNetTotal = _salesOrderHeaderDataAccess.GetProductTotalFromDetails(order.Id);

                if (order.TotalAmount > 0)
                {
                    // ✅ CORRECT FORMULA: 
                    // Delivery = Total(Gross) - Products(Net) - Discount
                    // Example: 1675 - 1101 - 449 = 125
                    order.DeliveryCharge = order.TotalAmount - productNetTotal - order.DiscountAmount;
                }
                else
                {
                    order.DeliveryCharge = 0;
                }

                // --- PROFIT CALCULATION (Optional, for internal use) ---
                // order.ActualLogisticsCost is already populated by DataAccess

                // --- DUE CALCULATION ---
                decimal net = order.NetAmount ?? 0m;
                decimal paid = order.PaidAmount;
                order.DueAmount = net - paid;
            }

            return orders;
        }        // ==========================================================================
                 // ✅ 2. CORRECTED: UpdateOrderConfirmation (Expense Snapshot Logic)
                 // ==========================================================================
                 // Inside MDUA.Facade/OrderFacade.cs

        // 1. Update signature to accept 'username'
        public string UpdateOrderConfirmation(int orderId, bool isConfirmed, string username)
        {
            string dbStatus = isConfirmed ? "Confirmed" : "Draft";

            using (var scope = new System.Transactions.TransactionScope())
            {
                try
                {
                    // Update Status
                    _salesOrderHeaderDataAccess.UpdateStatusSafe(orderId, dbStatus, isConfirmed);

                    if (isConfirmed)
                    {
                        var existingDelivery = _deliveryDataAccess.GetBySalesOrderIdExtended(orderId);

                        if (existingDelivery == null)
                        {
                            // --- 1. CALCULATE SHIPPING COST ---

                            // A. Get the Order Header to access TotalAmount & DiscountAmount
                            var order = _salesOrderHeaderDataAccess.GetOrderTotalsSafe(orderId);
                            if (order == null) throw new Exception("Order header not found.");

                            // B. Get Product Net Total (Sum of items)
                            // Assuming this method exists in your DAL based on your snippet
                            decimal productNetTotal = _salesOrderHeaderDataAccess.GetProductTotalFromDetails(orderId);

                            // C. Apply Formula: Delivery = Total - Products - Discount
                            decimal calculatedDeliveryCost = order.TotalAmount - productNetTotal - order.DiscountAmount;

                            // Safety check: Cost shouldn't be negative
                            if (calculatedDeliveryCost < 0) calculatedDeliveryCost = 0;

                            // --- 2. CREATE DELIVERY RECORD ---
                            var delivery = new Delivery
                            {
                                SalesOrderId = orderId,
                                TrackingNumber = "TRK-" + DateTime.UtcNow.Ticks.ToString().Substring(12),
                                Status = "Pending",

                                // ✅ Use Calculated Cost
                                ShippingCost = calculatedDeliveryCost,

                                // ✅ Use Logged-in User
                                CreatedBy = username,
                                CreatedAt = DateTime.UtcNow
                            };

                            long newDeliveryId = _deliveryDataAccess.InsertExtended(delivery);

                            // --- 3. INSERT ITEMS ---
                            if (newDeliveryId > 0)
                            {
                                // ✅ TRICK: Cast the interface to the concrete class
                                // This bypasses the "Interface does not contain definition" error
                                // because we are telling the compiler "Trust me, it's this specific class."
                                var concreteDetailDA = (SalesOrderDetailDataAccess)_salesOrderDetailDataAccess;

                                // Now you can call the method you added to the class!
                                var orderItems = concreteDetailDA.GetOrderDetailsSafe(orderId);
                                foreach (var item in orderItems)
                                {
                                    _deliveryDataAccess.InsertDeliveryItem(
                                        (int)newDeliveryId,
                                        item.Id,
                                        item.Quantity
                                    );
                                }
                            }
                        }
                    }

                    scope.Complete();
                }
                catch (Exception ex)
                {
                    throw new Exception($"ORDER_CONFIRM_ERROR: {ex.Message}");
                }
            }

            return dbStatus;
        }

        // ✅ 3. NEW: UpdateDeliveryStatus (Status Sync Logic)
        // ==========================================================================
        // In src/MDUA.Facade/OrderFacade.cs

        public void UpdateDeliveryStatus(int deliveryId, string newStatus)
        {

            var delivery = _deliveryDataAccess.GetExtended(deliveryId);

            if (delivery == null) throw new Exception("Delivery not found");
            if (delivery.SalesOrderId <= 0) throw new Exception("Data Error: Delivery has no Sales Order ID.");

            // 2) Update Delivery
            delivery.Status = newStatus;
            if (newStatus.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                delivery.ActualDeliveryDate = DateTime.UtcNow;

            _deliveryDataAccess.UpdateExtended(delivery);

            // 3) Map Delivery -> SOH.Status
            string parentStatus = null;
            string cleanStatus = (newStatus ?? "").ToLower().Trim();

            if (cleanStatus == "pending") parentStatus = "Draft";
            else if (cleanStatus == "shipped" || cleanStatus == "in transit" || cleanStatus == "out for delivery") parentStatus = "Shipped";
            else if (cleanStatus == "delivered") parentStatus = "Delivered";
            else if (cleanStatus == "returned" || cleanStatus == "returned to hub") parentStatus = "Returned";
            else if (cleanStatus == "cancelled") parentStatus = "Cancelled";


            // 4) Sync SalesOrderHeader
            // 4. Update SalesOrderHeader (Sync)
            if (parentStatus != null)
            {
                bool confirmedState = false;

                if (_salesOrderHeaderDataAccess is MDUA.DataAccess.SalesOrderHeaderDataAccess concrete)
                    confirmedState = concrete.GetConfirmedFlag(delivery.SalesOrderId);


                try
                {
                    // ✅ use the diagnostic updater (proves DB + rowsAffected)
                    if (_salesOrderHeaderDataAccess is MDUA.DataAccess.SalesOrderHeaderDataAccess concrete2)
                        concrete2.UpdateStatusSafeLogged(delivery.SalesOrderId, parentStatus, confirmedState);
                    else
                        _salesOrderHeaderDataAccess.UpdateStatusSafe(delivery.SalesOrderId, parentStatus, confirmedState);

                }
                catch (Exception ex)
                {
                    throw;
                }
            }
        }
        public void UpdateOrderStatus(int orderId, string newStatus)

        {

            // 1. REMOVE THIS LINE (This is what crashes):

            // var order = _salesOrderHeaderDataAccess.Get(orderId);

            // 2. Determine 'Confirmed' status logically

            // If we are Cancelling, unconfirm it. Otherwise, keep it confirmed (or confirm it).

            bool confirmedState = true;

            if (newStatus == "Cancelled" || newStatus == "Draft")

            {

                confirmedState = false;

            }

            // 3. Call the safe update method directly (Just like ToggleConfirmation does)

            _salesOrderHeaderDataAccess.UpdateStatusSafe(orderId, newStatus, confirmedState);

        }



        public List<dynamic> GetProductVariantsForAdmin()
        {
            var rawList = _salesOrderHeaderDataAccess.GetVariantsForDropdown();

            // Loop through and attach discount info from ProductFacade
            foreach (var item in rawList)
            {
                if (item.ContainsKey("ProductId") && item.ContainsKey("Price"))
                {
                    int pId = (int)item["ProductId"];
                    decimal price = (decimal)item["Price"];

                    var bestDiscount = _productFacade.GetBestDiscount(pId, price);

                    if (bestDiscount != null)
                    {
                        item["DiscountType"] = bestDiscount.DiscountType; // "Flat" or "Percentage"
                        item["DiscountValue"] = bestDiscount.DiscountValue;
                    }
                    else
                    {
                        item["DiscountType"] = "None";
                        item["DiscountValue"] = 0m;
                    }
                }
            }

            return new List<dynamic>(rawList);
        }

        // Change
        public dynamic PlaceAdminOrder(SalesOrderHeader orderData)
        {
            // 1. Stock Check
            var variantInfo = _salesOrderHeaderDataAccess.GetVariantStockAndPrice(orderData.ProductVariantId);
            if (variantInfo == null) throw new Exception("Variant not found.");

            if (variantInfo.Value.StockQty < orderData.OrderQuantity)
                throw new Exception($"Stock Error: Only {variantInfo.Value.StockQty} available.");

            decimal basePrice = variantInfo.Value.Price;

            // 2. Discount Calculation
            var variantBasic = _productVariantDataAccess.Get(orderData.ProductVariantId);
            decimal finalUnitPrice = basePrice;
            decimal totalDiscount = 0;

            var bestDiscount = _productFacade.GetBestDiscount(variantBasic.ProductId, basePrice);
            if (bestDiscount != null)
            {
                if (bestDiscount.DiscountType == "Flat")
                {
                    finalUnitPrice -= bestDiscount.DiscountValue;
                    totalDiscount = bestDiscount.DiscountValue * orderData.OrderQuantity;
                }
                else if (bestDiscount.DiscountType == "Percentage")
                {
                    decimal disc = basePrice * (bestDiscount.DiscountValue / 100);
                    finalUnitPrice -= disc;
                    totalDiscount = disc * orderData.OrderQuantity;
                }
            }

            // -------------------------------------------------------------
            // ✅ DELIVERY FEE LOGIC (Revenue)
            // -------------------------------------------------------------
            // We trust the "DeliveryCharge" sent from the UI (Editable Input)
            decimal deliveryFeeToCharge = orderData.DeliveryCharge;

            // A. Detect "In-Store" based on street naming convention from JS
            bool isStoreSale = !string.IsNullOrEmpty(orderData.Street) &&
                                orderData.Street.IndexOf("Counter Sale", StringComparison.OrdinalIgnoreCase) >= 0;

            // B. Apply to Totals
            decimal grossProductCost = basePrice * orderData.OrderQuantity;

            // DB Logic: [NetAmount] = [TotalAmount] - [DiscountAmount]
            // We want: [NetAmount] = (Product + Delivery) - Discount
            orderData.TotalAmount = grossProductCost + deliveryFeeToCharge;
            orderData.DiscountAmount = totalDiscount;

            // For Return Object
            decimal netAmount = orderData.TotalAmount - totalDiscount;

            // -------------------------------------------------------------
            // 3. SAVE TO DATABASE
            // -------------------------------------------------------------
            string connectionString = _configuration.GetConnectionString("DefaultConnection");
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();
                using (SqlTransaction transaction = connection.BeginTransaction())
                {
                    try
                    {
                        var transCustomerDA = new CustomerDataAccess(transaction);
                        var transCompanyCustomerDA = new CompanyCustomerDataAccess(transaction);
                        var transAddressDA = new AddressDataAccess(transaction);
                        var transOrderDA = new SalesOrderHeaderDataAccess(transaction);
                        var transDetailDA = new SalesOrderDetailDataAccess(transaction);

                        // ✅ Delivery DA for snapshot
                        var transDeliveryDA = new DeliveryDataAccess(transaction);

                        // A. Customer Logic
                        int customerId = 0;
                        var customer = transCustomerDA.GetByPhone(orderData.CustomerPhone);
                        string finalEmail = !string.IsNullOrEmpty(orderData.CustomerEmail)
                            ? orderData.CustomerEmail
                            : $"{orderData.CustomerPhone}@direct.local";

                        if (customer == null)
                        {
                            var newCust = new Customer
                            {
                                CustomerName = orderData.CustomerName,
                                Phone = orderData.CustomerPhone,
                                Email = finalEmail,
                                IsActive = true,
                                CreatedAt = DateTime.UtcNow,
                                CreatedBy = "Admin"
                            };
                            transCustomerDA.Insert(newCust);
                            customer = transCustomerDA.GetByPhone(orderData.CustomerPhone);
                        }
                        else
                        {
                            if (!string.IsNullOrEmpty(orderData.CustomerEmail) &&
                                (string.IsNullOrEmpty(customer.Email) || customer.Email.EndsWith(".local")))
                            {
                                customer.Email = orderData.CustomerEmail;
                                transCustomerDA.Update(customer);
                            }
                        }
                        customerId = customer.Id;

                        // B. Link
                        if (!transCompanyCustomerDA.IsLinked(orderData.TargetCompanyId, customerId))
                        {
                            transCompanyCustomerDA.Insert(new CompanyCustomer { CompanyId = orderData.TargetCompanyId, CustomerId = customerId });
                        }

                        // C. Address
                        var addr = new Address
                        {
                            CustomerId = customerId,
                            Street = orderData.Street,
                            City = orderData.City,
                            Divison = orderData.Divison,
                            Thana = orderData.Thana,
                            SubOffice = orderData.SubOffice,
                            Country = "Bangladesh",
                            AddressType = "Shipping",
                            CreatedBy = "Admin",
                            CreatedAt = DateTime.UtcNow,
                            PostalCode = orderData.PostalCode ?? "0000",
                            ZipCode = (orderData.ZipCode ?? "0000").ToCharArray()
                        };
                        var existingAddr = transAddressDA.CheckExistingAddress(customerId, addr);
                        int addressId = (existingAddr != null) ? existingAddr.Id : (int)transAddressDA.InsertAddressSafe(addr);

                        // D. Order Header
                        orderData.CompanyCustomerId = transCompanyCustomerDA.GetId(orderData.TargetCompanyId, customerId);
                        orderData.AddressId = addressId;
                        orderData.SalesChannelId = 2; // Direct
                        orderData.OrderDate = DateTime.UtcNow;
                        orderData.Status = orderData.Confirmed ? "Confirmed" : "Draft";
                        orderData.IsActive = true;
                        orderData.CreatedBy = "Admin";
                        orderData.CreatedAt = DateTime.UtcNow;

                        int orderId = (int)transOrderDA.InsertSalesOrderHeaderSafe(orderData);

                        // E. Order Detail
                        transDetailDA.InsertSalesOrderDetailSafe(new SalesOrderDetail
                        {
                            SalesOrderId = orderId,
                            ProductVariantId = orderData.ProductVariantId,
                            Quantity = orderData.OrderQuantity,
                            UnitPrice = finalUnitPrice, // Store Net Unit Price
                            CreatedBy = "Admin",
                            CreatedAt = DateTime.UtcNow
                        });

                        // ------------------------------------------------------------------
                        // ✅ 4. EXPENSE SNAPSHOT (If Confirmed, Freeze Cost in Delivery Table)
                        // ------------------------------------------------------------------
                        // Note: Only create delivery record if it's NOT a Store Pickup
                        if (orderData.Confirmed && !isStoreSale)
                        {
                            // Logic to retrieve Standard Cost from Settings (Expense Tracking)
                            int companyId = orderData.TargetCompanyId > 0 ? orderData.TargetCompanyId : 1;
                            var settings = _settingsFacade.GetDeliverySettings(companyId) ?? new Dictionary<string, int>();

                            bool isDhaka = (!string.IsNullOrEmpty(orderData.Divison) &&
                                            orderData.Divison.IndexOf("dhaka", StringComparison.OrdinalIgnoreCase) >= 0)
                                            || (!string.IsNullOrEmpty(orderData.City) &&
                                            orderData.City.IndexOf("dhaka", StringComparison.OrdinalIgnoreCase) >= 0);

                            // Fetch ACTUAL COST (Expense) from Settings
                            // If keys don't exist, fallback to revenue defaults or 0
                            decimal costInside = settings.ContainsKey("Cost_InsideDhaka") ? settings["Cost_InsideDhaka"] : (settings.ContainsKey("dhaka") ? settings["dhaka"] : 60);
                            decimal costOutside = settings.ContainsKey("Cost_OutsideDhaka") ? settings["Cost_OutsideDhaka"] : (settings.ContainsKey("outside") ? settings["outside"] : 120);

                            decimal actualCost = isDhaka ? costInside : costOutside;

                            var delivery = new Delivery
                            {
                                SalesOrderId = orderId,
                                TrackingNumber = "DO-" + DateTime.UtcNow.Ticks.ToString().Substring(12),
                                Status = "Pending",
                                ShippingCost = actualCost, // ✅ EXPENSE (Standard Cost)
                                CreatedBy = "Admin_Direct",
                                CreatedAt = DateTime.UtcNow
                            };

                            // Use the Extended Insert logic
                            transDeliveryDA.InsertExtended(delivery);
                        }

                        transaction.Commit();

                        return new
                        {
                            OrderId = "DO" + orderId.ToString("D8"),
                            NetAmount = netAmount,
                            DiscountAmount = totalDiscount,
                            TotalAmount = orderData.TotalAmount,
                            DeliveryFee = deliveryFeeToCharge // Return the charged amount
                        };
                    }
                    catch
                    {
                        transaction.Rollback();
                        throw;
                    }
                }
            }
        }
        //new
        public DashboardStats GetDashboardMetrics()
        {
            return _salesOrderHeaderDataAccess.GetDashboardStats();
        }

        //new
        public List<SalesOrderHeader> GetRecentOrders()
        {
            return _salesOrderHeaderDataAccess.GetRecentOrders(5); // Get top 5
        }
        //new
        public List<ChartDataPoint> GetSalesTrend()
        {
            return _salesOrderHeaderDataAccess.GetSalesTrend(6);
        }
        //new
        public List<ChartDataPoint> GetOrderStatusCounts()
        {
            return _salesOrderHeaderDataAccess.GetOrderStatusCounts();
        }



        #endregion
    }
}

using MDUA.DataAccess;
using MDUA.DataAccess.Interface;
using MDUA.Entities;
using MDUA.Entities.Bases;
using MDUA.Entities.List;
using MDUA.Facade.Interface;
using MDUA.Framework;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using static MDUA.Entities.ProductVariant;
using System.Net; 

namespace MDUA.Facade
{
    public class ProductFacade : IProductFacade
    {
        private readonly IAttributeNameDataAccess _attributeNameDataAccess;
        private readonly IProductDataAccess _ProductDataAccess;
        private readonly IProductImageDataAccess _ProductImageDataAccess;
        private readonly IProductReviewDataAccess _ProductReviewDataAccess;
        private readonly IProductVariantDataAccess _ProductVariantDataAccess;
        private readonly IProductDiscountDataAccess _ProductDiscountDataAccess;
        private readonly IProductCategoryDataAccess _categoryDataAccess;
        private readonly IProductAttributeDataAccess _productAttributeDataAccess;
        private readonly IVariantPriceStockDataAccess _variantPriceStockDataAccess;
        private readonly IVariantImageDataAccess _variantImageDataAccess;
        private readonly ICompanyDataAccess _companyDataAccess;
        private readonly IProductVideoDataAccess _productVideoDataAccess;
        private readonly IGlobalSettingDataAccess _globalSettingDataAccess;
        private static readonly List<string> _sizeSortOrder = new List<string>

        {
            "XXXS", "XXS", "XS", "S", "M", "L", "XL", "XXL", "2XL", "XXXL", "3XL", "4XL", "5XL"
        };

        public ProductFacade(
            IProductDataAccess productDataAccess,
            IProductImageDataAccess productImageDataAccess,
            IProductReviewDataAccess productReviewDataAccess,
            IProductVariantDataAccess productVariantDataAccess,
            IProductDiscountDataAccess productDiscountDataAccess,
            IProductCategoryDataAccess categoryDataAccess,
            IAttributeNameDataAccess attributeNameDataAccess,
            IProductAttributeDataAccess productAttributeDataAccess,
            IVariantPriceStockDataAccess variantPriceStockDataAccess,
            IVariantImageDataAccess variantImageDataAccess,
            ICompanyDataAccess companyDataAccess,
            IGlobalSettingDataAccess globalSettingDataAccess,
            IProductVideoDataAccess productVideoDataAccess)
        {
            _ProductDataAccess = productDataAccess;
            _ProductImageDataAccess = productImageDataAccess;
            _ProductReviewDataAccess = productReviewDataAccess;
            _ProductVariantDataAccess = productVariantDataAccess;
            _ProductDiscountDataAccess = productDiscountDataAccess;
            _categoryDataAccess = categoryDataAccess;
            _attributeNameDataAccess = attributeNameDataAccess;
            _productAttributeDataAccess = productAttributeDataAccess;
            _variantPriceStockDataAccess = variantPriceStockDataAccess;
            _variantImageDataAccess = variantImageDataAccess;
            _companyDataAccess = companyDataAccess;
            _globalSettingDataAccess = globalSettingDataAccess;
            _productVideoDataAccess = productVideoDataAccess;
        }

        #region Common Implementation
        public long Delete(int id) => _ProductDataAccess.Delete(id);

        public Product Get(int id) => _ProductDataAccess.Get(id);

        public ProductList GetAll() => _ProductDataAccess.GetAll();

        public ProductList GetByQuery(string query) => _ProductDataAccess.GetByQuery(query);

        public long Insert(ProductBase obj) => _ProductDataAccess.Insert(obj);

        public long Update(ProductBase obj) => _ProductDataAccess.Update(obj);
        #endregion

        #region Extended Implementation

        public Product GetProductDetailsForWebBySlug(string slug)
        {
            Product product = _ProductDataAccess.GetBySlug(slug);

            if (product == null || !product.IsActive)
                return null;

            // 1. Load related entities
            product.Images = _ProductImageDataAccess.GetByProductId(product.Id);
            product.Reviews = _ProductReviewDataAccess.GetByProductId(product.Id);
            product.Variants = _ProductVariantDataAccess.GetByProductId(product.Id);
            // Note: We don't fetch Active
            //
            //
            // here anymore, we calculate BestDiscount below

            // 2. Load Dynamic Specifications (Truth-Based)
            product.Specifications = _attributeNameDataAccess.GetSpecificationsByProductId(product.Id);

            // 3. Populate Available Sizes
            var sizeKey = product.Specifications.Keys
                .FirstOrDefault(k => k.Contains("size", StringComparison.OrdinalIgnoreCase)
                                  || k.Contains("dimension", StringComparison.OrdinalIgnoreCase));

            if (sizeKey != null)
            {
                product.AvailableSizes = product.Specifications[sizeKey];
            }
            else
            {
                product.AvailableSizes = product.Specifications.Values.FirstOrDefault() ?? new List<string>();
            }

            // 4. Sort AvailableSizes (S, M, L, XL...)
            product.AvailableSizes = product.AvailableSizes
                .OrderBy(s =>
                {
                    var safeSize = (s ?? "").ToUpper().Trim();
                    var index = _sizeSortOrder.IndexOf(safeSize);
                    return index == -1 ? 999 : index;
                })
                .ThenBy(s => s)
                .ToList();

            // 5. Update Specifications with the SORTED list
            if (sizeKey != null)
            {
                product.Specifications[sizeKey] = product.AvailableSizes;
            }

            // 6. Calculate Best Discount Strategy (ONCE)
            decimal basePrice = product.BasePrice ?? 0;
            var bestDiscount = GetBestDiscount(product.Id, basePrice);

            // 7. Loop Variants (Handle Stock, Images, and Pricing together)
            int totalStock = 0;
            foreach (var v in product.Variants)
            {
                // A. Stock Logic
                try
                {
                    var stockInfo = _variantPriceStockDataAccess.Get(v.Id);
                    if (stockInfo != null)
                    {
                        v.StockQty = stockInfo.StockQty;
                        totalStock += v.StockQty;
                        // Sync price if missing in variant table
                        if (v.VariantPrice == 0 || v.VariantPrice == null) v.VariantPrice = stockInfo.Price;
                    }
                }
                catch { }

                // B. Image Logic
                var images = _variantImageDataAccess.GetImagesForVariant(v.Id);
                if (images != null && images.Count > 0)
                {
                    string rawPath = images[0].ImageUrl;
                    if (!string.IsNullOrEmpty(rawPath))
                    {
                        v.VariantImageUrl = rawPath.Replace("\\", "/");
                        if (!v.VariantImageUrl.StartsWith("/")) v.VariantImageUrl = "/" + v.VariantImageUrl;
                    }
                }

               

                // C. Pricing Logic
                decimal vPrice = v.VariantPrice ?? 0;
                decimal vSellingPrice = vPrice;

                if (bestDiscount != null)
                {
                    if (bestDiscount.DiscountType.Equals("Flat", StringComparison.OrdinalIgnoreCase))
                        vSellingPrice -= bestDiscount.DiscountValue;
                    else if (bestDiscount.DiscountType.Equals("Percentage", StringComparison.OrdinalIgnoreCase))
                        vSellingPrice -= (vPrice * (bestDiscount.DiscountValue / 100));
                }

                v.DiscountedPrice = Math.Max(vSellingPrice, 0);
            }
            var videos = _productVideoDataAccess.GetByProductId(product.Id);

            // Find Primary or fallback to first
            var primaryVideo = videos.FirstOrDefault(v => v.IsPrimary) ?? videos.FirstOrDefault();

            if (primaryVideo != null)
            {
                product.ProductVideoUrl = primaryVideo.VideoUrl;
            }
            product.TotalStockQuantity = totalStock;

            // 8. Calculate Main Product Selling Price (Using Best Discount)
            decimal sellingPrice = basePrice;

            if (bestDiscount != null)
            {
                if (bestDiscount.DiscountType.Equals("Flat", StringComparison.OrdinalIgnoreCase))
                    sellingPrice -= bestDiscount.DiscountValue;
                else if (bestDiscount.DiscountType.Equals("Percentage", StringComparison.OrdinalIgnoreCase))
                    sellingPrice -= (basePrice * (bestDiscount.DiscountValue / 100));
            }

            product.SellingPrice = Math.Max(sellingPrice, 0);
            product.ActiveDiscount = bestDiscount; // Assign to model for UI

            // 9. Load Company Info
            var company = _companyDataAccess.GetCompanySafe(product.CompanyId);
            if (company != null)
            {
                string dbLogo = company.LogoImg;
                if (string.IsNullOrEmpty(dbLogo))
                {
                    product.CompanyLogoUrl = "/images/logo.jpg";
                }
                else if (dbLogo.StartsWith("/images/") || dbLogo.StartsWith("\\images\\"))
                {
                    product.CompanyLogoUrl = dbLogo;
                }
                else
                {
                    product.CompanyLogoUrl = $"/images/logo/{company.Id}/{dbLogo}";
                }
                product.CompanyName = company.CompanyName;
            }
            else
            {
                product.CompanyLogoUrl = "/images/logo.jpg";
            }

            string dhakaStr = _globalSettingDataAccess.GetValue(product.CompanyId, "DeliveryCharge_Dhaka");
            string outsideStr = _globalSettingDataAccess.GetValue(product.CompanyId, "DeliveryCharge_Outside");

            int.TryParse(dhakaStr, out int dhakaCharge);
            int.TryParse(outsideStr, out int outsideCharge);

            // Fallback defaults if DB is empty
            if (dhakaCharge == 0) dhakaCharge = 60;
            if (outsideCharge == 0) outsideCharge = 120;

            product.DeliveryCharges = new Dictionary<string, int>
    {
        { "dhaka", dhakaCharge },
        { "outside", outsideCharge }
    };

            return product;
        }
        public long AddProduct(Product product, string username, int companyId)

        {

            if (product == null)

                throw new ArgumentNullException(nameof(product));

            product.CompanyId = companyId;

            product.CreatedBy = username;

            product.UpdatedBy = username;

            product.CreatedAt = DateTime.UtcNow;

            product.UpdatedAt = DateTime.UtcNow;

            product.ReorderLevel = product.ReorderLevel < 0 ? 0 : product.ReorderLevel;

            // 1️⃣ INSERT PRODUCT

            long productId = _ProductDataAccess.Insert(product);

            if (productId <= 0)

                return productId;

            // 2️⃣ INSERT ATTRIBUTES (If any selected)

            if (product.Attributes != null && product.Attributes.Count > 0)

            {

                int displayOrder = 1;

                foreach (var attr in product.Attributes)

                {

                    attr.ProductId = (int)productId;

                    attr.DisplayOrder = displayOrder++;

                    _productAttributeDataAccess.Insert(attr);

                }

            }

            // 3️⃣ HANDLE VARIANTS

            // If user provided variants (e.g. Size: S, M, L), insert them normally.

            if (product.Variants != null && product.Variants.Count > 0)

            {

                foreach (var variant in product.Variants)

                {

                    variant.ProductId = (int)productId;

                    variant.CreatedBy = username;

                    variant.CreatedAt = DateTime.UtcNow;

                    int variantId = _ProductVariantDataAccess.Insert(variant);

                    if (variantId > 0)

                    {

                        var vps = new VariantPriceStock

                        {

                            Id = variantId,

                            Price = (decimal)(variant.VariantPrice ?? product.BasePrice), // Fallback to Base Price

                            CompareAtPrice = null,

                            CostPrice = null,

                            StockQty = 0,

                            TrackInventory = true,

                            AllowBackorder = false,

                            WeightGrams = null

                        };

                        _variantPriceStockDataAccess.Insert(vps);

                        // Insert Attribute Values for this specific variant

                        if (variant.AttributeValueIds != null)

                        {

                            int displayOrder = 1;

                            foreach (int valueId in variant.AttributeValueIds)

                            {

                                _ProductVariantDataAccess.InsertVariantAttributeValue(

                                    variantId, valueId, displayOrder++);

                            }

                        }

                    }

                }

            }

            else

            {

                // ✅ DEFAULT VARIANT LOGIC (For Simple Products)

                // If NO variants were provided, create one "Standard" variant automatically.

                // This ensures SalesOrderDetail and Inventory tables can link to a Variant ID.

                var defaultVariant = new ProductVariant

                {

                    ProductId = (int)productId,

                    VariantName = "Standard", // Internal name for simple products
                    VariantPrice = (decimal)( product.BasePrice), // Fallback to Base Price

                    IsActive = true,

                    CreatedBy = username,

                    CreatedAt = DateTime.UtcNow

                };

                int defaultVariantId = _ProductVariantDataAccess.Insert(defaultVariant);

                if (defaultVariantId > 0)

                {

                    // Link Price & Stock to this default variant

                    var vps = new VariantPriceStock

                    {

                        Id = defaultVariantId,

                        Price = (decimal)product.BasePrice, // Use the product's main price

                        CompareAtPrice = null,

                        CostPrice = null,

                        StockQty = 0, // Default stock 0, updated via Purchase later

                        TrackInventory = true,

                        AllowBackorder = false,

                        WeightGrams = null

                    };

                    _variantPriceStockDataAccess.Insert(vps);

                }

            }

            return productId;

        }

        public ProductList GetLastFiveProducts()
        {
            return _ProductDataAccess.GetLastFiveProducts();
        }

        public List<Product> GetAllProductsWithCategory()
        {
            var products = _ProductDataAccess.GetAll(); // returns List<Product> or ProductList

            // Get all categories in one query
            var categories = _categoryDataAccess.GetAll().ToDictionary(c => c.Id, c => c.Name);

            // Fill CategoryName for each product
            foreach (var p in products)
            {
                if (p.CategoryId.HasValue && categories.ContainsKey(p.CategoryId.Value))
                    p.CategoryName = categories[p.CategoryId.Value];
                else
                    p.CategoryName = "N/A";

                decimal basePrice = p.BasePrice ?? 0;

                // ✅ NEW: Get the Single Best Discount
                var bestDiscount = GetBestDiscount(p.Id, basePrice);

                decimal sellingPrice = basePrice;

                if (bestDiscount != null)
                {
                    if (bestDiscount.DiscountType == "Flat")
                        sellingPrice -= bestDiscount.DiscountValue;
                    else if (bestDiscount.DiscountType == "Percentage")
                        sellingPrice -= (basePrice * (bestDiscount.DiscountValue / 100));
                }

                p.SellingPrice = Math.Max(sellingPrice, 0);
                p.ActiveDiscount = bestDiscount; // The View will show this specific discount
            }

            return products.ToList();
        }

        public UserLoginResult GetAddProductData(int userId)
        {
            var result = new UserLoginResult
            {
                Categories = _categoryDataAccess.GetAll()?.ToList() ?? new List<ProductCategory>(),
                Attributes = _attributeNameDataAccess.GetAll()?.ToList() ?? new List<AttributeName>()
            };

            return result;
        }

        public List<AttributeValue> GetAttributeValues(int attributeId)
        {
            return _attributeNameDataAccess.GetValuesByAttributeId(attributeId);
        }

        public ProductVariantList GetVariantsByProductId(int productId)
        {
            return _ProductVariantDataAccess.GetProductVariantsByProductId(productId);
        }

        public bool? ToggleProductStatus(int productId)
        {
            return _ProductDataAccess.ToggleStatus(productId);
        }

        public Product GetProductDetails(int productId)
        {
            // 1. Get the base product
            // We use GetProductById, which you already have.
            Product product = _ProductDataAccess.GetProductById(productId);
            if (product == null)
            {
                return null;
            }

            // 2. Get its variants
            // We use GetProductVariantsByProductId, which you also have.
            product.Variants = _ProductVariantDataAccess.GetProductVariantsByProductId(productId).ToList();

            // 3. Get its category name
            if (product.CategoryId.HasValue)
            {
                // Assuming _categoryDataAccess.Get(id) exists
                var category = _categoryDataAccess.Get(product.CategoryId.Value);
                product.CategoryName = category?.Name ?? "N/A";
            }
            else
            {
                product.CategoryName = "N/A";
            }

            return product;
        }

        public ProductResult GetProductForEdit(int productId)
        {
            var model = new ProductResult
            {
                // ✅ THIS IS THE FIX
                Product = _ProductDataAccess.Get(productId),

                Categories = _categoryDataAccess.GetAll()?.ToList() ?? new List<ProductCategory>()
            };

            return model;
        }

        public long UpdateProduct(Product product, string username)
        {
            product.UpdatedBy = username;
            product.UpdatedAt = DateTime.UtcNow;// [cite_start]// [cite: 179]
                     return _ProductDataAccess.Update(product);
        }
        public long UpdateVariantPrice(int variantId, decimal newPrice, string newSku)
        {
            return _variantPriceStockDataAccess.UpdatePrice(variantId, newPrice,  newSku);
        }
        public long DeleteVariant(int variantId)
        {
         
            return _ProductVariantDataAccess.Delete(variantId);
        }

        public List<AttributeName> GetAttributesForProduct(int productId)
        {
            return _attributeNameDataAccess.GetByProductId(productId);
        }

        public long AddVariantToExistingProduct(ProductVariant variant)
        {
            // 1. Insert Variant
            int variantId = _ProductVariantDataAccess.Insert(variant);

            if (variantId > 0)
            {
                // 2. Insert Price/Stock
                var vps = new VariantPriceStock
                {
                    Id = variantId,
                    Price = variant.VariantPrice ?? 0,
                    StockQty = variant.StockQty,
                    TrackInventory = true,
                    AllowBackorder = false
                };
                _variantPriceStockDataAccess.Insert(vps);

                // 3. Insert Attributes
                if (variant.AttributeValueIds != null)
                {
                    int displayOrder = 1;
                    foreach (int valueId in variant.AttributeValueIds)
                    {
                        _ProductVariantDataAccess.InsertVariantAttributeValue(variantId, valueId, displayOrder++);
                    }
                }
            }
            return variantId;
        }

        public ProductVariantResult GetVariantsWithAttributes(int productId)
        {
            var result = new ProductVariantResult();
            result.ProductId = productId;
            var product = _ProductDataAccess.Get(productId);
            decimal basePrice = product?.BasePrice ?? 0;
            result.BasePrice = basePrice;

            var variantList = _ProductVariantDataAccess.GetProductVariantsByProductId(productId);
            result.Variants = new List<ProductVariant>(variantList);

            var bestDiscount = GetBestDiscount(productId, basePrice);

            // Apply to variants
            foreach (var v in result.Variants)
            {
                decimal vPrice = v.VariantPrice ?? 0;
                decimal vSellingPrice = vPrice;

                if (bestDiscount != null)
                {
                    if (bestDiscount.DiscountType == "Flat")
                        vSellingPrice -= bestDiscount.DiscountValue;
                    else if (bestDiscount.DiscountType == "Percentage")
                        vSellingPrice -= (vPrice * (bestDiscount.DiscountValue / 100));
                }

                v.DiscountedPrice = vSellingPrice < 0 ? 0 : vSellingPrice;
            }       // MUST USE GetAll() to fetch attributes for the dropdown list
            result.AvailableAttributes = _attributeNameDataAccess.GetAll()?.ToList()
                                                 ?? new List<AttributeName>();
            result.ReorderLevel = product?.ReorderLevel ?? 0;
            return result;
                }

        public List<AttributeName> GetMissingAttributesForVariant(int productId, int variantId)
        {
            return _attributeNameDataAccess.GetMissingAttributesForVariant(productId, variantId);
        }

        // 2. Add Attribute & Auto-Update Name

        public void AddAttributeToVariant(int variantId, int attributeValueId)
        {
            // 1. Insert the link (Attribute -> Variant)
            _ProductVariantDataAccess.InsertVariantAttributeValue(variantId, attributeValueId, 99);

            // 2. Get the text for the value we just added (e.g., "Cotton")
            string valueName = _attributeNameDataAccess.GetValueName(attributeValueId);

            // 3. Get the current Variant to see its old name
            var variant = _ProductVariantDataAccess.Get(variantId);

            if (variant != null && !string.IsNullOrEmpty(valueName))
            {
                // 4. Append the new value to the existing name
                // Old: "Product - Red" -> New: "Product - Red - Cotton"
                string newVariantName = $"{variant.VariantName} - {valueName}";

                // 5. Save the new name safely
                _ProductVariantDataAccess.UpdateVariantName(variantId, newVariantName);
            }
        }

        // 3. Implement the Methods
        public List<ProductDiscount> GetDiscountsByProductId(int productId)
        {
            // Using the method from your DAL
            return _ProductDiscountDataAccess.GetByProductId(productId).ToList();
        }

        public long AddDiscount(ProductDiscount discount)
        {
            // Set defaults if needed
            discount.CreatedAt = DateTime.UtcNow;
            discount.UpdatedAt = DateTime.UtcNow;
            return _ProductDiscountDataAccess.Insert(discount);
        }

        public long UpdateDiscount(ProductDiscount discount)
        {
            discount.UpdatedAt = DateTime.UtcNow;
            return _ProductDiscountDataAccess.Update(discount);
        }

        public long DeleteDiscount(int id)
        {
            return _ProductDiscountDataAccess.Delete(id);
        }

        public Product GetProductWithPrice(int productId)
        {
            var product = _ProductDataAccess.Get(productId);
            if (product == null) return null;

            decimal basePrice = product.BasePrice ?? 0;
            var bestDiscount = GetBestDiscount(productId, basePrice);

            decimal sellingPrice = basePrice;

            if (bestDiscount != null)
            {
                if (bestDiscount.DiscountType == "Flat")
                    sellingPrice -= bestDiscount.DiscountValue;
                else if (bestDiscount.DiscountType == "Percentage")
                    sellingPrice -= (basePrice * (bestDiscount.DiscountValue / 100));
            }

            product.SellingPrice = Math.Max(sellingPrice, 0);
            product.ActiveDiscount = bestDiscount;

            return product;
        }

        // Helper to find the single best discount from a list of potential discounts
        // In src/MDUA.Facade/ProductFacade.cs

        public ProductDiscount GetBestDiscount(int productId, decimal basePrice)
        {
            var allDiscounts = _ProductDiscountDataAccess.GetByProductId(productId);

            DateTime now = DateTime.UtcNow;

            // 3. Filter discounts
            var validDiscounts = allDiscounts
                .Where(d => d.IsActive
                         && d.EffectiveFrom <= now
                         && (d.EffectiveTo == null || d.EffectiveTo >= now))
                .ToList();

            if (!validDiscounts.Any()) return null;

            // 4. Calculate the Best Price Strategy (lowest price wins)
            ProductDiscount bestDiscount = null;
            decimal lowestPriceFound = basePrice;

            foreach (var d in validDiscounts)
            {
                decimal calculatedPrice = basePrice;

                if (string.Equals(d.DiscountType, "Flat", StringComparison.OrdinalIgnoreCase))
                {
                    calculatedPrice -= d.DiscountValue;
                }
                else if (string.Equals(d.DiscountType, "Percentage", StringComparison.OrdinalIgnoreCase))
                {
                    calculatedPrice -= (basePrice * (d.DiscountValue / 100));
                }

                // Ensure price doesn't drop below zero
                calculatedPrice = Math.Max(calculatedPrice, 0);

                if (calculatedPrice < lowestPriceFound)
                {
                    lowestPriceFound = calculatedPrice;
                    bestDiscount = d;
                }
            }

            return bestDiscount;
        }
        public List<ProductImage> GetProductImages(int productId)
        {
            // Calls the Data Access layer
            return _ProductImageDataAccess.GetByProductId(productId).ToList();
        }
        public long AddProductImage(int productId, string imageUrl, bool isPrimary, string username)
        {
            // 1. Check if any images already exist for this product
            var existingImages = _ProductImageDataAccess.GetByProductId(productId);
            bool isFirstImage = (existingImages.Count == 0);

            var img = new ProductImage
            {
                ProductId = productId,
                ImageUrl = imageUrl,

                // ✅ LOGIC: If User said Primary OR it's the First Image -> True
                IsPrimary = isPrimary || isFirstImage,

                SortOrder = existingImages.Count + 1, // Auto-increment sort order
                AltText = "Product Image",
                CreatedBy = username,
                CreatedAt = DateTime.UtcNow
            };
            return _ProductImageDataAccess.Insert(img);
        }

        public List<VariantImage> GetVariantImages(int variantId)
        {
            return _variantImageDataAccess.GetImagesForVariant(variantId).ToList();
        }

        public long AddVariantImage(int variantId, string imageUrl, string username)
        {
            var img = new VariantImage
            {
                VariantId = variantId,
                ImageUrl = imageUrl,
                AltText = "Variant Image",
                DisplayOrder = 1
            };
            return _variantImageDataAccess.Insert(img);
        }

        public long DeleteVariantImage(int imageId)
        {
            return _variantImageDataAccess.Delete(imageId);
        }

        public long DeleteProductImage(int imageId)
        {
            // Calls the Data Access delete method
            return _ProductImageDataAccess.Delete(imageId);
        }

        public ProductImage GetProductImage(int id)
        {
            // Uses the existing .Get(id) method in your DataAccess
            return _ProductImageDataAccess.Get(id);
        }

        public VariantImage GetVariantImage(int id)
        {
            // Uses the existing .Get(id) method in your DataAccess
            return _variantImageDataAccess.Get(id);
        }

        public void SetProductImageAsPrimary(int imageId, int productId)
        {
            // 1. Get all images for this product
            var allImages = _ProductImageDataAccess.GetByProductId(productId);

            foreach (var img in allImages)
            {
                if (img.Id == imageId)
                {
                    // Set this one as Primary
                    if (!img.IsPrimary)
                    {
                        img.IsPrimary = true;
                        _ProductImageDataAccess.Update(img);
                    }
                }
                else
                {
                    // Unset others
                    if (img.IsPrimary)
                    {
                        img.IsPrimary = false;
                        _ProductImageDataAccess.Update(img);
                    }
                }
            }
        }

        public void UpdateProductImageSortOrder(int imageId, int sortOrder)
        {
            var img = _ProductImageDataAccess.Get(imageId);
            if (img != null)
            {
                img.SortOrder = sortOrder;
                _ProductImageDataAccess.Update(img);
            }
        }
        public void UpdateVariantImageDisplayOrder(int imageId, int displayOrder)
        {
            // 1. Get existing image
            var img = _variantImageDataAccess.Get(imageId);

            if (img != null)
            {
                // 2. Update property
                img.DisplayOrder = displayOrder;

                // 3. Save to DB using existing Update method
                _variantImageDataAccess.Update(img);
            }
        }

        public ProductList SearchProducts(string searchTerm)
        {
            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                return new ProductList();
            }
            return _ProductDataAccess.SearchProducts(searchTerm);
        }
        #endregion


        // =========================================================
        // VIDEO MANAGEMENT REGION
        // =========================================================
        public List<ProductVideo> GetProductVideos(int productId)
        {
            // Get list ordered by SortOrder
            return _productVideoDataAccess.GetByProductId(productId)
                                          .OrderBy(v => v.SortOrder)
                                          .ToList();
        }
        public async Task<long> AddProductVideo(ProductVideo video, string username)
        {
            // A. Validate generic requirements
            if (video == null) throw new ArgumentNullException(nameof(video));
            if (string.IsNullOrWhiteSpace(video.VideoUrl)) throw new ArgumentException("Video URL is required.");

            // B. SERVER-SIDE VALIDATION & CONVERSION
            string embedUrl = await ConvertToEmbedUrl(video.VideoUrl);

            // If the conversion returned null/empty, it means the URL was invalid.
            if (string.IsNullOrEmpty(embedUrl))
            {
                throw new ArgumentException("Invalid Video URL. Only YouTube, Vimeo, and Facebook are supported.");
            }

            // C. Set the validated/converted URL
            video.VideoUrl = embedUrl;

            // D. Audit Fields
            video.CreatedBy = username;
            video.CreatedAt = DateTime.UtcNow;
            video.UpdatedBy = username;
            video.UpdatedAt = DateTime.UtcNow;

            if (string.IsNullOrEmpty(video.ThumbnailUrl)) video.ThumbnailUrl = "";

            // E. Sort Order Logic
            var existingVideos = _productVideoDataAccess.GetByProductId(video.ProductId);
            if (existingVideos != null && existingVideos.Count > 0)
            {
                video.SortOrder = existingVideos.Max(v => v.SortOrder) + 1;
            }
            else
            {
                video.SortOrder = 1;
                video.IsPrimary = true; // First video is always primary
            }

            // F. Primary Logic
            if (video.IsPrimary && existingVideos != null && existingVideos.Count > 0)
            {
                var currentPrimary = existingVideos.FirstOrDefault(v => v.IsPrimary);
                if (currentPrimary != null)
                {
                    currentPrimary.IsPrimary = false;
                    currentPrimary.UpdatedBy = username;
                    currentPrimary.UpdatedAt = DateTime.UtcNow;
                    _productVideoDataAccess.Update(currentPrimary);
                }
            }

            return _productVideoDataAccess.Insert(video);
        }
        public async Task<string> ConvertToEmbedUrl(string url)
        {
            if (string.IsNullOrEmpty(url)) return null;

            // 1. Resolve Redirects (Share links) - CRITICAL for loading content
            if (url.Contains("facebook.com/share/") || url.Contains("fb.watch"))
            {
                // Now awaiting the async method
                string resolvedUrl = await ResolveRedirect(url);
                if (!string.IsNullOrEmpty(resolvedUrl)) url = resolvedUrl;
            }

            // 2. Already Embedded Check
            if (url.Contains("facebook.com/plugins/video.php") ||
                url.Contains("player.vimeo.com/video/") ||
                url.Contains("youtube.com/embed/"))
            {
                return url;
            }

            // 3. YouTube (Handles Standard, Shorts, Embed, Youtu.be)
            var ytMatch = System.Text.RegularExpressions.Regex.Match(url, @"(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?|shorts)\/|.*[?&]v=)|youtu\.be\/)([^""&?\/\s]{11})", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            if (ytMatch.Success)
            {
                return $"https://www.youtube.com/embed/{ytMatch.Groups[1].Value}";
            }

            // 4. Vimeo (Handles vimeo.com/ID and player.vimeo.com/video/ID)
            var vimeoMatch = System.Text.RegularExpressions.Regex.Match(url, @"(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            if (vimeoMatch.Success)
            {
                return $"https://player.vimeo.com/video/{vimeoMatch.Groups[1].Value}";
            }

            // 5. Facebook
            if (url.Contains("facebook.com"))
            {
                var encodedUrl = System.Net.WebUtility.UrlEncode(url);
                return $"https://www.facebook.com/plugins/video.php?href={encodedUrl}&show_text=false&width=560";
            }

            return null;
        }

        private async Task<string> ResolveRedirect(string url)
        {
            try
            {
                using (var handler = new HttpClientHandler { AllowAutoRedirect = true })
                using (var client = new HttpClient(handler))
                {
                    client.DefaultRequestHeaders.UserAgent.ParseAdd("Mozilla/5.0 (Windows NT 10.0; Win64; x64)");

                    var request = new HttpRequestMessage(HttpMethod.Head, url);

                    var response = await client.SendAsync(request);

                    // will contain the final URI after the redirect chain.
                    return response.RequestMessage?.RequestUri?.AbsoluteUri ?? url;
                }
            }
            catch
            {
                // If resolution fails (e.g. timeout), return original url and hope for the best
                return url;
            }
        }

        public long DeleteProductVideo(int videoId)
        {
            // 1. Fetch the video first to check its status
            var videoToDelete = _productVideoDataAccess.Get(videoId);

            // Safety check: if video doesn't exist, stop
            if (videoToDelete == null) return 0;

            // 2. Logic: If we are deleting the PRIMARY video...
            if (videoToDelete.IsPrimary)
            {
                // Fetch all videos for this product
                var allVideos = _productVideoDataAccess.GetByProductId(videoToDelete.ProductId);

                // Find the "Next Best" video:
                // - Exclude the one we are deleting
                // - Order by SortOrder (ascending) so the next one in the list takes over
                var nextPrimary = allVideos
                                    .Where(v => v.Id != videoId)
                                    .OrderBy(v => v.SortOrder)
                                    .ThenBy(v => v.Id)
                                    .FirstOrDefault();

                // If a candidate exists, promote it
                if (nextPrimary != null)
                {
                    nextPrimary.IsPrimary = true;
                    nextPrimary.UpdatedAt = DateTime.UtcNow;
                    // Note: We don't have the username passed to this method signature, 
                    // but since it's an auto-system action, null/empty UpdatedBy is often acceptable.

                    _productVideoDataAccess.Update(nextPrimary);
                }
            }

            // 3. Finally, delete the target video
            return _productVideoDataAccess.Delete(videoId);
        }
        public void SetPrimaryProductVideo(int videoId, int productId, string username)
        {
            // 1. Get all videos
            var allVideos = _productVideoDataAccess.GetByProductId(productId);

            // 2. Loop and update to ensure ONLY ONE is primary
            foreach (var v in allVideos)
            {
                // Determine if this is the chosen one
                bool shouldBePrimary = (v.Id == videoId);

                // Only update the database if the status is actually changing
                if (v.IsPrimary != shouldBePrimary)
                {
                    v.IsPrimary = shouldBePrimary;
                    v.UpdatedBy = username;
                    v.UpdatedAt = DateTime.UtcNow;

                    _productVideoDataAccess.Update(v);
                }
            }
        }
        public List<LowStockItem> GetLowStockVariants(int topN)
        {
            return _variantPriceStockDataAccess.GetLowStockVariants(topN);
        }

      
    }
}
