document.addEventListener("DOMContentLoaded",function(){const o=document.getElementById("requestModal"),i=document.getElementById("infoModal"),r=document.getElementById("receiveModal");[o,i,r].forEach(e=>{e&&e.parentNode!==document.body&&document.body.appendChild(e)});const c=new bootstrap.Modal(o),f=new bootstrap.Modal(i),l=new bootstrap.Modal(r);document.querySelectorAll(".btn-request").forEach(e=>{e.addEventListener("click",function(){document.getElementById("reqVariantId").value=this.dataset.variantId,document.getElementById("reqProductName").value=this.dataset.name,document.getElementById("reqQty").value=this.dataset.suggested,c.show()})}),document.querySelectorAll(".btn-req-info").forEach(e=>{e.addEventListener("click",function(){const s=this.dataset.variantId,n=document.getElementById("infoModalBody");n.innerHTML='<div class="text-center text-muted py-5"><div class="spinner-border text-info"></div><div class="mt-2">Loading details...</div></div>',f.show(),fetch(`/purchase/get-pending-info?variantId=${s}`).then(t=>t.json()).then(t=>{if(t.success&&t.data){const a=t.data;n.innerHTML=`
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Request ID</span>
                                    <span class="fw-bold">PO #${a.id}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Vendor</span>
                                    <span class="fw-bold text-dark">${a.vendorName}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Requested Quantity</span>
                                    <span class="badge bg-warning text-dark fs-6">${a.quantity}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Request Date</span>
                                    <span>${a.requestDate}</span>
                                </div>
                                <div class="list-group-item p-3">
                                    <span class="text-muted d-block mb-2">Remarks</span>
                                    <div class="bg-light p-2 rounded border text-break text-secondary small">
                                        ${a.remarks||"No remarks provided."}
                                    </div>
                                </div>
                            </div>`}else n.innerHTML=`<div class="text-center text-danger py-4 p-3">${t.message||"Data not found"}</div>`}).catch(()=>{n.innerHTML='<div class="text-center text-danger py-4">Failed to load data.</div>'})})}),document.querySelectorAll(".btn-receive").forEach(e=>{e.addEventListener("click",function(){const s=this.dataset.variantId,n=this.dataset.name;document.getElementById("recVariantId").value=s,document.getElementById("recProductName").textContent=n,document.getElementById("recQty").value="",document.getElementById("recPrice").value="",document.getElementById("recInvoice").value="",document.getElementById("recRemarks").value="",document.getElementById("recReqQty").value="Loading...",l.show(),fetch(`/purchase/get-pending-info?variantId=${s}`).then(t=>t.json()).then(t=>{if(t.success&&t.data){const a=t.data.quantity;document.getElementById("recReqQty").value=a,document.getElementById("recQty").value=a}else document.getElementById("recReqQty").value="N/A"})})});const u=document.getElementById("btnConfirmRequest");u&&u.addEventListener("click",function(){v("/purchase/create-request",{VendorId:parseInt(document.getElementById("reqVendor").value),ProductVariantId:parseInt(document.getElementById("reqVariantId").value),Quantity:parseInt(document.getElementById("reqQty").value)},this,c)});const m=document.getElementById("btnConfirmReceive");m&&m.addEventListener("click",function(){const e={ProductVariantId:parseInt(document.getElementById("recVariantId").value),Quantity:parseInt(document.getElementById("recQty").value),BuyingPrice:parseFloat(document.getElementById("recPrice").value),InvoiceNo:document.getElementById("recInvoice").value,Remarks:document.getElementById("recRemarks").value};if(!e.ProductVariantId||isNaN(e.ProductVariantId)){alert("System Error: Variant ID missing");return}if(!e.Quantity||e.Quantity<1){alert("Please enter a valid quantity.");return}if(isNaN(e.BuyingPrice)||e.BuyingPrice<0){alert("Please enter a valid total cost.");return}v("/purchase/receive-stock",e,this,l)});function v(e,s,n,t){const a=n.textContent;n.disabled=!0,n.textContent="Processing...";const y=document.querySelector('input[name="__RequestVerificationToken"]')?.value,g={"Content-Type":"application/json"};y&&(g.RequestVerificationToken=y),fetch(e,{method:"POST",headers:g,body:JSON.stringify(s)}).then(async d=>{const p=d.headers.get("content-type");if(p&&p.includes("application/json"))return await d.json();throw new Error("Invalid Server Response")}).then(d=>{if(d.success)typeof Swal<"u"?Swal.fire("Success!",d.message||"Operation Successful","success").then(()=>location.reload()):(alert(d.message||"Success!"),location.reload()),t.hide();else throw new Error(d.message||"Unknown Error")}).catch(d=>{typeof Swal<"u"?Swal.fire("Error",d.message,"error"):alert("Error: "+d.message),n.disabled=!1,n.textContent=a})}});
